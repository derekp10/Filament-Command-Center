<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Command Center {{ version }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #0e0e0e; color: #f0f0f0; font-family: 'Segoe UI', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .navbar { background-color: #1a1a1a; border-bottom: 2px solid #00d4ff; flex-shrink: 0; }
        .navbar-brand { color: #00d4ff !important; font-weight: bold; font-size: 1.5rem; }
        .version-tag { color: #888; font-size: 1rem; margin-left: 10px; font-weight: bold; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-on { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .status-off { background-color: #ff4444; box-shadow: 0 0 5px #ff4444; }
        .main-container { flex-grow: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
        .col-logs { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        .log-box { flex-grow: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 1.2rem; line-height: 1.6; }
        .log-INFO { color: #00ff00; } .log-WARNING { color: #ffcc00; } .log-ERROR { color: #ff4444; }
        .col-buffer { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        .buffer-header { padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; color: #00d4ff; font-size: 1.2rem; display: flex; justify-content: space-between; }
        .buffer-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .buffer-item { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; margin-bottom: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .buffer-swatch { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; }
        .buffer-text { font-size: 1.6rem; color: white; font-weight: bold; }
        .qr-box { background: white; padding: 5px; border-radius: 4px; }
        .cmd-deck { padding: 15px; border-top: 1px solid #333; background: #222; display: flex; justify-content: space-around; }
        .modal-content { background-color: #121212; color: #fff; border: 1px solid #555; }
        .table-dark { --bs-table-bg: #181818; }
        .highlight-row { border: 4px solid #ffff00 !important; background-color: #333 !important; }
        .eject-btn { padding: 15px 30px; font-size: 1.5rem; border-radius: 8px; height: 100%; display: flex; align-items: center; }
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 11000; text-align: center; width: 80%; max-width: 600px; }
        .toast-msg { background: rgba(0,0,0,0.95); color: #fff; padding: 30px; margin-bottom: 20px; border: 4px solid #00d4ff; border-radius: 12px; font-size: 2rem; font-weight: bold; }
        #focus-guard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: none; justify-content: center; align-items: center; border: 20px solid #ff4444; text-align: center; backdrop-filter: blur(5px); }
    </style>
</head>
<body>
    <div id="focus-guard" onclick="document.body.focus()"><div><div style="font-size:5rem;">üö´</div><div style="font-size:3rem;color:#ff4444;font-weight:bold;">SCANNER PAUSED</div></div></div>
    <div id="toast-container"></div>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <div class="d-flex align-items-center"><span class="navbar-brand">Filament Command Center</span><span class="version-tag">{{ version }}</span></div>
            <div class="d-flex align-items-center">
                <div style="margin-right:20px; color:#ccc;"><span id="st-spoolman" class="status-dot status-off"></span> Spoolman</div>
                <div style="margin-right:20px; color:#ccc;"><span id="st-filabridge" class="status-dot status-off"></span> FilaBridge</div>
                <button class="btn btn-outline-info btn-sm me-3" onclick="openLocationsModal()">üìÇ Locations</button>
                <button onclick="triggerUndo()" class="btn btn-warning btn-sm me-3" id="undo-btn" disabled>‚Ü©Ô∏è UNDO</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="col-logs"><div class="p-3 border-bottom border-secondary text-info fw-bold">Live Activity üì°</div><div id="live-logs" class="log-box"></div></div>
        <div class="col-buffer">
            <div class="buffer-header"><span>BUFFER ZONE</span><span id="scan-status" style="font-size:1rem; color:#888;">Ready...</span></div>
            <div id="buffer-zone" class="buffer-content"></div>
            <div class="cmd-deck">
                <div class="text-center"><div class="qr-box" id="qr-clear"></div>CLEAR</div>
                <div class="text-center"><div class="qr-box" id="qr-undo"></div>UNDO</div>
                <div class="text-center"><div class="qr-box" id="qr-eject"></div>EJECT</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locMgrModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Location Manager</h5><div class="ms-auto text-muted" id="loc-count">0 Locs</div><button class="btn btn-success btn-lg ms-3" onclick="openAddModal()">+ New Slot</button><button type="button" class="btn-close btn-close-white ms-3" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><table class="table table-hover table-dark mb-0" style="font-size:1.1rem;"><thead><tr><th>ID</th><th>Name</th><th>Status</th><th class="text-end">Actions</th></tr></thead><tbody id="location-table"></tbody></table></div></div></div></div>
    <div class="modal fade" id="locModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle">Edit Location</h5><button type="button" class="btn-close btn-close-white" onclick="closeEdit()"></button></div><div class="modal-body"><input type="hidden" id="edit-original-id"><div class="mb-3"><label>Location ID</label><input type="text" class="form-control" id="edit-id"></div><div class="mb-3"><label>Friendly Name</label><input type="text" class="form-control" id="edit-name"></div><div class="row"><div class="col-8 mb-3"><label>Type</label><select class="form-select" id="edit-type"><option value="Dryer Box">Dryer Box</option><option value="Cart">Cart</option><option value="Shelf">Shelf</option><option value="Printer">Printer</option><option value="MMU Slot">MMU Slot</option></select></div><div class="col-4 mb-3"><label>Max Spools</label><input type="number" class="form-control" id="edit-max"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeEdit()">Cancel</button><button type="button" class="btn btn-primary" onclick="saveLocation()">Save</button></div></div></div></div>
    
    <div class="modal fade" id="manageModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="manageTitle">Manage</h5><button type="button" class="btn-close btn-close-white" onclick="closeManage()"></button></div><div class="modal-body"><div id="manage-contents-list" class="mb-4"></div><hr class="border-secondary"><div class="input-group mb-3"><input type="text" id="manual-spool-id" class="form-control form-control-lg" placeholder="Enter Spool ID / Scan Legacy"><button class="btn btn-primary btn-lg" onclick="manualAddSpool()">‚ûï Add</button></div><div class="d-grid gap-2"><button class="btn btn-success btn-lg" onclick="closeManage()">‚úÖ Done / Sync Buffer</button></div><input type="hidden" id="manage-loc-id"></div></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border: 4px solid #ffcc00;"><div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold">‚ö†Ô∏è CONFIRM ACTION</h5></div><div class="modal-body text-center"><p id="confirm-msg" style="font-size:1.5rem;">Are you sure?</p><div class="bg-white p-2 d-inline-block rounded mb-2"><div id="qr-confirm"></div><div class="small fw-bold text-dark">CMD:CONFIRM</div></div></div><div class="modal-footer justify-content-center"><button type="button" class="btn btn-secondary btn-lg" style="width:40%;" onclick="confirmAction(false)">NO</button><button type="button" class="btn btn-warning btn-lg" style="width:40%;" onclick="confirmAction(true)">YES</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.onload = function() {
            new QRCode(document.getElementById("qr-undo"), {text: "CMD:UNDO", width: 90, height: 90});
            new QRCode(document.getElementById("qr-clear"), {text: "CMD:CLEAR", width: 90, height: 90});
            new QRCode(document.getElementById("qr-eject"), {text: "CMD:EJECT", width: 90, height: 90});
            new QRCode(document.getElementById("qr-confirm"), {text: "CMD:CONFIRM", width: 128, height: 128});
            
            document.getElementById("manual-spool-id").addEventListener("keydown", function(event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    manualAddSpool();
                }
            });
        };
        
        window.onblur = function() { document.getElementById('focus-guard').style.display = 'flex'; };
        window.onfocus = function() { document.getElementById('focus-guard').style.display = 'none'; };

        let scanBuffer = "";
        let bufferTimeout;
        let heldSpools = []; 
        let ejectMode = false;
        let lastScannedLoc = null;
        let pendingConfirmCallback = null;
        let allLocations = []; 

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('focus-guard').style.display === 'flex') return;
            if (e.target.tagName === 'INPUT') return; 
            if (e.key === 'Enter') { processScan(scanBuffer); scanBuffer = ""; } 
            else if (e.key.length === 1) { 
                scanBuffer += e.key; 
                document.getElementById('scan-status').innerText = "Scanning: " + scanBuffer; 
                clearTimeout(bufferTimeout); 
                bufferTimeout = setTimeout(() => { scanBuffer = ""; document.getElementById('scan-status').innerText = "Ready"; }, 2000); 
            }
        });

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast-msg`;
            el.style.borderColor = type === 'error' ? '#ff4444' : (type === 'warning' ? '#ffcc00' : '#00d4ff');
            el.innerText = msg; container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 2000);
        }

        function renderBuffer() {
            const zone = document.getElementById('buffer-zone');
            if (heldSpools.length > 0) {
                zone.innerHTML = heldSpools.map((s, idx) => `
                    <div class="buffer-item">
                        <div class="buffer-info"><div class="buffer-swatch" style="background-color:#${s.color}"></div><div class="buffer-text">${s.display}</div></div>
                        <div id="qr-buf-${idx}" class="qr-box"></div>
                    </div>`).join('');
                heldSpools.forEach((s, idx) => { new QRCode(document.getElementById(`qr-buf-${idx}`), {text: "ID:" + s.id.toString(), width: 120, height: 120}); });
            } else { zone.innerHTML = `<div class="text-center text-muted mt-5"><h3>Buffer Empty</h3><p>Scan a Spool or Location</p></div>`; }
        }

        function processScan(text) {
            fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: text}) }).then(r => r.json()).then(res => {
                if(res.type === 'command' && res.cmd === 'confirm') { if(pendingConfirmCallback) confirmAction(true); return; }
                if(res.type === 'location') { lastScannedLoc = res.id; if(document.getElementById('locMgrModal').classList.contains('show')) scrollToRow(res.id); }
                if (ejectMode) {
                    ejectMode = false; document.getElementById('buffer-zone').style.border = "none";
                    if (res.type === 'spool') ejectSpool(res.id, "Scan");
                    else if (res.type === 'location') {
                        requestConfirmation("Clear ALL items from " + res.id + "?", () => {
                            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'clear_location', location: res.id, spool_id: 0}) })
                            .then(r => r.json()).then(d => { if(d.success) showToast("‚úÖ CLEARED " + res.id, "warning"); showToast(d.msg, "error"); fetchLogs(); });
                        });
                    }
                    return;
                }
                if (res.type === 'spool') {
                    if (heldSpools.some(s => s.id === res.id)) showToast("‚ö†Ô∏è ALREADY IN BUFFER", "warning");
                    else { heldSpools.push({id: res.id, display: res.display, color: res.color}); renderBuffer(); }
                } else if (res.type === 'location') {
                    if (heldSpools.length > 0) executeMove(res.id); 
                    else {
                        if (res.contents && res.contents.length > 0) {
                            res.contents.forEach(s => { if (!heldSpools.some(h => h.id === s.id)) heldSpools.push(s); });
                            renderBuffer(); showToast(`Loaded ${res.contents.length} Items`, "info");
                        } else showToast("Location is Empty", "warning");
                    }
                } else if (res.type === 'command') {
                    if (res.cmd === 'undo') triggerUndo();
                    if (res.cmd === 'clear') { heldSpools = []; renderBuffer(); showToast("BUFFER CLEARED", "info"); }
                    if (res.cmd === 'eject') { ejectMode = true; showToast("‚ö†Ô∏è SCAN ITEM TO EJECT", "warning"); document.getElementById('buffer-zone').style.border = "4px solid #ff4444"; }
                }
            });
        }

        function executeMove(targetLoc) {
            const spoolIds = heldSpools.map(s => s.id);
            fetch('/api/smart_move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({location: targetLoc, spools: spoolIds}) }).then(r => r.json()).then(data => { 
                if(data.status === 'success') { heldSpools = []; renderBuffer(); showToast("‚úÖ MOVE COMPLETE", "info"); } else showToast("‚ùå " + data.msg, "error");
                fetchLogs(); 
            });
        }

        const locMgrModal = new bootstrap.Modal(document.getElementById('locMgrModal'));
        const locModal = new bootstrap.Modal(document.getElementById('locModal'));
        const manageModal = new bootstrap.Modal(document.getElementById('manageModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

        function requestConfirmation(msg, callback) { document.getElementById('confirm-msg').innerText = msg; pendingConfirmCallback = callback; confirmModal.show(); }
        function confirmAction(isYes) { confirmModal.hide(); if(isYes && pendingConfirmCallback) pendingConfirmCallback(); pendingConfirmCallback = null; }

        function openLocationsModal() { locMgrModal.show(); fetchLocations(); }
        function scrollToRow(id) {
            setTimeout(() => {
                const row = document.getElementById(`row-${id}`);
                document.querySelectorAll('.highlight-row').forEach(el => el.classList.remove('highlight-row'));
                if(row) { row.scrollIntoView({behavior: "smooth", block: "center"}); row.classList.add('highlight-row'); }
            }, 500);
        }

        function fetchLocations() {
            fetch('/api/locations').then(r => r.json()).then(data => {
                allLocations = data; 
                document.getElementById('loc-count').innerText = data.length + " Locs";
                document.getElementById('location-table').innerHTML = data.map(l => `
                    <tr id="row-${l.LocationID}">
                        <td style="font-weight:bold;color:#00d4ff;">${l.LocationID}</td>
                        <td>${l.Name}</td>
                        <td>${l.Occupancy || ''} <span class="badge bg-secondary ms-2">${l.Type}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="openEdit('${l.LocationID}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteLoc('${l.LocationID}')">üóëÔ∏è</button>
                            <button class="btn btn-sm btn-info" onclick="openManage('${l.LocationID}')">Manage</button>
                        </td>
                    </tr>`).join('');
                if(lastScannedLoc) scrollToRow(lastScannedLoc);
            });
        }

        function openManage(locId) {
            document.getElementById('manageTitle').innerText = `Manage: ${locId}`;
            document.getElementById('manage-loc-id').value = locId;
            document.getElementById('manual-spool-id').value = "";
            refreshManageList(locId);
            manageModal.show();
        }
        function closeManage() { manageModal.hide(); heldSpools = []; renderBuffer(); fetchLocations(); }

        function refreshManageList(locId) {
            document.getElementById('manage-contents-list').innerHTML = "<div class='text-center'>Loading...</div>";
            fetch(`/api/get_contents?id=${locId}`).then(r => r.json()).then(data => {
                const list = document.getElementById('manage-contents-list');
                if (data.length === 0) list.innerHTML = "<div class='text-center text-muted'>Empty</div>";
                else {
                    list.innerHTML = data.map((s, idx) => `
                        <div class="manage-item mb-3 p-2 bg-dark border border-secondary rounded d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div id="qr-man-${idx}" class="bg-white p-1 me-3 rounded"></div>
                                <div>
                                    <div class="fw-bold fs-5">#${s.id}</div>
                                    <div class="d-flex align-items-center">
                                        <div class="buffer-swatch me-2" style="width:20px;height:20px;background-color:#${s.color};"></div>
                                        <span class="text-muted small">${s.display}</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-danger eject-btn" onclick="ejectSpool(${s.id}, '${locId}')">‚èèÔ∏è EJECT</button>
                        </div>`).join('');
                    data.forEach((s, idx) => { new QRCode(document.getElementById(`qr-man-${idx}`), {text: "ID:" + s.id.toString(), width: 64, height: 64}); });
                }
            });
        }

        function ejectSpool(spoolId, locId) { if(locId !== "Scan") { requestConfirmation("Eject spool #" + spoolId + "?", () => { doEject(spoolId, locId); }); } else doEject(spoolId, locId); }
        function doEject(spoolId, locId) {
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'remove', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then((res) => { 
                if(locId !== "Scan") refreshManageList(locId); 
                fetchLogs(); 
                if(locId === "Scan") showToast("‚èèÔ∏è EJECTED", "warning");
            });
        }

        function manualAddSpool() {
            const locId = document.getElementById('manage-loc-id').value;
            const spoolId = document.getElementById('manual-spool-id').value;
            if(!spoolId) return;
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'add', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then(res => {
                if(res.status === 'error') alert(res.msg);
                else {
                    document.getElementById('manual-spool-id').value = ""; 
                    setTimeout(() => refreshManageList(locId), 300);
                    fetchLogs();
                }
            });
        }

        function openAddModal() { locMgrModal.hide(); document.getElementById('modalTitle').innerText = "Add New Location"; document.getElementById('edit-original-id').value = ""; document.getElementById('edit-id').value = ""; document.getElementById('edit-name').value = ""; document.getElementById('edit-max').value = "1"; locModal.show(); }
        function openEdit(locId) {
            const item = allLocations.find(l => l.LocationID === locId); if(!item) return;
            locMgrModal.hide(); document.getElementById('modalTitle').innerText = "Edit Location"; document.getElementById('edit-original-id').value = locId; document.getElementById('edit-id').value = locId;
            document.getElementById('edit-name').value = item.Name || ""; document.getElementById('edit-type').value = item.Type || "Dryer Box"; document.getElementById('edit-max').value = item['Max Spools'] || "1"; locModal.show();
        }
        function closeEdit() { locModal.hide(); locMgrModal.show(); }
        function saveLocation() { 
            const payload = { old_id: document.getElementById('edit-original-id').value, new_data: { LocationID: document.getElementById('edit-id').value, Name: document.getElementById('edit-name').value, Type: document.getElementById('edit-type').value, "Max Spools": document.getElementById('edit-max').value, "Label Printed": "No" }};
            fetch('/api/locations', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }).then(() => { lastScannedLoc = payload.new_data.LocationID; locModal.hide(); locMgrModal.show(); setTimeout(fetchLocations, 200); });
        }
        function deleteLoc(id) { 
            requestConfirmation("Delete Location " + id + " AND unassign all spools?", () => { 
                fetch('/api/locations?id=' + id, { method: 'DELETE' }).then(() => { 
                    lastScannedLoc = null; // Fix: Clear ghost scanner location
                    fetchLocations(); 
                }); 
            }); 
        }
        function triggerUndo() { fetch('/api/undo', { method: 'POST' }).then(() => fetchLogs()); }
        function fetchLogs() {
            fetch('/api/logs').then(r => r.json()).then(data => {
                document.getElementById('live-logs').innerHTML = data.logs.map(l => `<div class="log-${l.type}">[${l.time}] ${l.msg}</div>`).join('');
                document.getElementById('undo-btn').disabled = !data.undo_available;
                document.getElementById('st-spoolman').className = `status-dot ${data.status.spoolman ? 'status-on' : 'status-off'}`;
                document.getElementById('st-filabridge').className = `status-dot ${data.status.filabridge ? 'status-on' : 'status-off'}`;
            });
        }
        setInterval(fetchLogs, 2500);
    </script>
</body>
</html>