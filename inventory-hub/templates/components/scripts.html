<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DASHBOARD_VERSION = "v153.53 (Slim & Smart)";
    console.log("üöÄ Filament Command Center Dashboard Loaded: " + DASHBOARD_VERSION);

    let wakeLock = null;
    const requestWakeLock = async () => { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log(err); } } };
    document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') await requestWakeLock(); });
    document.addEventListener('click', requestWakeLock, { once: true });
    requestWakeLock();

    let modals = {}; 
    let state = { scanBuffer: "", bufferTimeout: null, heldSpools: [], ejectMode: false, dropMode: false, lastScannedLoc: null, pendingConfirm: null, pendingSafety: null, allLocations: [], logsPaused: false, currentGrid: {}, processing: false, modalCallbacks: [], activeModal: null, auditActive: false, lastAuditState: null };

    document.addEventListener('DOMContentLoaded', () => {
        if (!document.getElementById('focus-guard')) {
            const fg = document.createElement('div');
            fg.id = 'focus-guard';
            fg.innerHTML = `<div class="focus-msg">‚ö†Ô∏è CLICK HERE TO ACTIVATE SCANNER ‚ö†Ô∏è</div>`;
            document.body.appendChild(fg);
        }

        const vTag = document.querySelector('.version-tag');
        if(vTag) vTag.innerText = DASHBOARD_VERSION;

        ['locMgrModal', 'locModal', 'manageModal', 'confirmModal', 'actionModal', 'safetyModal'].forEach(id => modals[id] = new bootstrap.Modal(document.getElementById(id)));
        
        // Generate All QRs
        generateSafeQR('qr-undo', 'CMD:UNDO', 40);
        generateSafeQR('qr-clear', 'CMD:CLEAR', 40);
        generateSafeQR('qr-drop', 'CMD:DROP', 40);
        generateSafeQR('qr-eject', 'CMD:EJECT', 40); 
        generateSafeQR('qr-audit', 'CMD:AUDIT', 40);

        const modalQRs = {'qr-safety-yes': 'CMD:CONFIRM', 'qr-safety-no': 'CMD:CANCEL', 'qr-confirm-yes': 'CMD:CONFIRM', 'qr-confirm-no': 'CMD:CANCEL'};
        for(const [id, txt] of Object.entries(modalQRs)) generateSafeQR(id, txt, 120);

        document.getElementById('location-table').addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-manage');
            if (btn) openManage(btn.dataset.id);
            else if (e.target.closest('.btn-edit')) openEdit(e.target.closest('.btn-edit').dataset.id);
            else if (e.target.closest('.btn-delete')) deleteLoc(e.target.closest('.btn-delete').dataset.id);
        });

        document.getElementById("manual-spool-id").addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); manualAddSpool(); }});
        updateLogState(); fetchLocations(); 
    });

    const generateSafeQR = (elementId, text, size) => {
        setTimeout(() => {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = "";
                try { new QRCode(el, { text: text, width: size, height: size, correctLevel: QRCode.CorrectLevel.L }); } catch(e) {}
            }
        }, 50);
    };

    const getTintedBackground = (hex) => {
        if (!hex) return "#1a1a1a";
        hex = hex.replace('#', '');
        if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
        const r = parseInt(hex.substring(0,2), 16), g = parseInt(hex.substring(2,4), 16), b = parseInt(hex.substring(4,6), 16);
        const mix = 0.35; 
        return `rgb(${Math.floor(r*mix)}, ${Math.floor(g*mix)}, ${Math.floor(b*mix)})`;
    };
    
    const getFilamentStyle = (colorStr) => {
        if (!colorStr) return { frame: '#333', inner: '#1a1a1a' };
        if (colorStr.includes(',')) {
            const colors = colorStr.split(',').map(c => c.trim().startsWith('#') ? c.trim() : '#' + c.trim());
            const gradient = `linear-gradient(135deg, ${colors.join(', ')})`;
            const tint = getTintedBackground(colors[0]);
            return { frame: gradient, inner: tint };
        } 
        const hex = colorStr.startsWith('#') ? colorStr : '#' + colorStr;
        return { frame: hex, inner: getTintedBackground(hex) };
    };

    window.addEventListener('blur', () => { const g = document.getElementById('focus-guard'); if(g) g.style.display = 'flex'; });
    window.addEventListener('focus', () => { const g = document.getElementById('focus-guard'); if(g) g.style.display = 'none'; });
    document.addEventListener('keydown', (e) => {
        const g = document.getElementById('focus-guard');
        if ((g && g.style.display === 'flex') || state.processing || e.target.tagName === 'INPUT') return;
        if (e.key === 'Enter') { e.preventDefault(); if (state.scanBuffer.length > 0) processScan(state.scanBuffer); state.scanBuffer = ""; }
        else if (e.key.length === 1) { state.scanBuffer += e.key; clearTimeout(state.bufferTimeout); state.bufferTimeout = setTimeout(() => state.scanBuffer = "", 2000); }
    });

    const pauseLogs = (isPaused) => {
        state.logsPaused = isPaused;
        const el = document.getElementById('log-status');
        if (isPaused) { el.innerText = "PAUSED ‚è∏"; el.style.color = "#fc0"; el.classList.remove('text-muted'); } 
        else { el.innerText = "Auto-Refresh ON"; el.style.color = "#0f0"; el.classList.remove('text-muted'); }
    };

    const setProcessing = (s) => { 
        let ov = document.getElementById('processing-overlay');
        if (!ov) { ov = document.createElement('div'); ov.id = 'processing-overlay'; ov.style.cssText = "display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"; document.body.appendChild(ov); }
        state.processing = s; ov.style.display = s ? 'block' : 'none'; 
    };
    
    const showToast = (msg, type='info') => {
        let c = document.getElementById('toast-container');
        if (!c) { c = document.createElement('div'); c.id = 'toast-container'; document.body.appendChild(c); }
        const el = document.createElement('div'); el.className = 'toast-msg'; el.innerText = msg; el.style.borderColor = type==='error'?'#f44':(type==='warning'?'#fc0':'#00d4ff');
        c.appendChild(el); setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 2000);
    };

    const hexToRgb = (hex) => { if (!hex) return {r:'', g:'', b:''}; hex = hex.replace('#', ''); const i = parseInt(hex, 16); return { r: (i >> 16) & 255, g: (i >> 8) & 255, b: i & 255 }; };
    const printLabel = (sid) => {
        showToast("üñ®Ô∏è Printing Label..."); setProcessing(true);
        fetch(`/api/spool_details?id=${sid}`).then(r=>r.json()).then(data => {
            setProcessing(false); if (!data || !data.filament) { showToast("No data for label", "error"); return; }
            const fil = data.filament, extra = fil.extra || {}, colorHex = fil.color_hex || '000000', rgb = hexToRgb(colorHex);
            let typeStr = fil.material || "Unknown";
            try { let attrs = (typeof extra.filament_attributes === 'string') ? JSON.parse(extra.filament_attributes) : extra.filament_attributes; if (Array.isArray(attrs) && attrs.length > 0) typeStr = attrs.join(' ') + ' ' + typeStr; } catch (err) {}
            const qrEl = document.getElementById('print-qr'); if (qrEl) { qrEl.innerHTML = ""; new QRCode(qrEl, {text: `ID:${sid}`, width: 120, height: 120, correctLevel: QRCode.CorrectLevel.L}); }
            document.getElementById('lbl-brand').innerText = fil.vendor ? fil.vendor.name : "Generic";
            document.getElementById('lbl-color').innerText = extra.original_color ? extra.original_color.replace(/"/g, '') : fil.name; 
            document.getElementById('lbl-type').innerText = typeStr;
            document.getElementById('lbl-hex').innerText = colorHex.toUpperCase();
            document.getElementById('lbl-id').innerText = sid;
            document.getElementById('lbl-rgb').innerText = `${rgb.r},${rgb.g},${rgb.b}`; 
            setTimeout(() => window.print(), 500);
        }).catch(e => { setProcessing(false); showToast("Print Error", "error"); });
    };

    const removeBufferItem = (id) => {
        const idx = state.heldSpools.findIndex(s => s.id == id);
        if (idx > -1) {
            state.heldSpools.splice(idx, 1);
            renderBuffer();
            showToast("Item Dropped üóëÔ∏è");
            // AUTO EXIT DROP MODE IF EMPTY
            if (state.dropMode && state.heldSpools.length === 0) toggleDropMode();
        } else { showToast("Item not in buffer", "warning"); }
    };

    const requestClearBuffer = () => {
        if (state.heldSpools.length === 0) return;
        requestConfirmation("Clear entire Buffer?", clearBuffer);
    };

    const clearBuffer = () => {
        state.heldSpools = [];
        renderBuffer();
        showToast("Buffer Cleared");
    };

    const toggleDropMode = () => {
        state.dropMode = !state.dropMode;
        state.ejectMode = false;
        updateDeckVisuals();
    };

    const toggleEjectMode = () => {
        state.ejectMode = !state.ejectMode;
        state.dropMode = false;
        updateDeckVisuals();
    };

    // --- AUDIT FIX ---
    const toggleAudit = () => { 
        if (state.auditActive) processScan("CMD:DONE"); 
        else processScan("CMD:AUDIT"); 
    };

    const updateDeckVisuals = () => {
        const dropBtn = document.getElementById('btn-deck-drop');
        const ejectBtn = document.getElementById('btn-deck-eject');
        const bufCol = document.querySelector('.col-buffer');
        
        if(dropBtn) dropBtn.classList.remove('drop-mode-active');
        if(ejectBtn) ejectBtn.classList.remove('eject-mode-active');
        if(bufCol) bufCol.classList.remove('drop-mode-active', 'eject-mode-active');

        if (state.dropMode) {
            if(dropBtn) dropBtn.classList.add('drop-mode-active');
            if(bufCol) bufCol.classList.add('drop-mode-active');
            showToast("DROP MODE: Scan to delete", "warning");
        } else if (state.ejectMode) {
            if(ejectBtn) ejectBtn.classList.add('eject-mode-active');
            if(bufCol) bufCol.classList.add('eject-mode-active');
            showToast("EJECT MODE: Scan to remove spool", "warning");
        }
    };

    const renderBuffer = () => {
        const z = document.getElementById('buffer-zone');
        const h = document.getElementById('headsup-buffer'); 
        const n = document.getElementById('buffer-nav-deck'); 

        if (state.heldSpools.length === 0) { 
            z.innerHTML = `<div class="buffer-empty-msg">Buffer Empty</div>`; 
            if(h) h.style.display = 'none'; 
            if(n) n.style.display = 'none'; 
            return; 
        }
        
        z.innerHTML = state.heldSpools.map((s, i) => {
            const styles = getFilamentStyle(s.color);
            const cleanText = s.display.replace(/^#\d+\s*/, '').trim();
            // INJECTED INNER STYLE FOR CHAMELEON LOOK
            return `
            <div class="filament-frame buffer-item ${i===0?'active-item':''}" style="background: ${styles.frame}; border:none;">
                <div class="buffer-inner" style="background-color:${styles.inner};">
                    <div class="buffer-info-group">
                        <div class="buffer-id-tag">#${s.id}</div>
                        <div class="buffer-text">${cleanText}</div>
                    </div>
                    <div class="buffer-actions">
                        <div class="btn-buffer-x" onclick="removeBufferItem(${s.id})">‚ùå</div>
                        <div id="qr-buf-${i}" class="buffer-qr"></div>
                    </div>
                </div>
            </div>`;
        }).join('');
        
        state.heldSpools.forEach((s, i) => generateSafeQR(`qr-buf-${i}`, "ID:"+s.id, 56)); // Smaller QR for slimmer bar

        if (h) {
            const top = state.heldSpools[0];
            const styles = getFilamentStyle(top.color);
            const cleanText = top.display.replace(/^#\d+\s*/, '').trim();
            h.style.display = 'block';
            h.style.background = styles.frame;
            h.style.padding = "5px"; 
            h.innerHTML = `
            <div class="filament-inner" style="background-color:${styles.inner}; padding: 5px 15px;">
                <div class="d-flex align-items-center gap-3">
                    <div class="fs-4 fw-bold text-warning">‚úã READY:</div>
                    <div class="buffer-id-tag" style="font-size:1.2rem; min-width:60px;">#${top.id}</div>
                    <div class="buffer-text" style="font-size:1.2rem;">${cleanText}</div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="btn-drop" onclick="removeBufferItem(${top.id})">‚ùå</div>
                    <div id="qr-headsup" class="bg-white p-1 rounded"></div>
                </div>
            </div>`;
            generateSafeQR("qr-headsup", "ID:"+top.id, 50);
        }

        if (n) {
            if (state.heldSpools.length > 1) {
                const nextSpool = state.heldSpools[1];
                const prevSpool = state.heldSpools[state.heldSpools.length - 1];
                const prevStyles = getFilamentStyle(prevSpool.color);
                const nextStyles = getFilamentStyle(nextSpool.color);
                
                n.style.display = 'flex';
                n.innerHTML = `
                    <div class="nav-card" style="background: ${prevStyles.frame}" onclick="prevBuffer()">
                        <div class="nav-inner" style="background-color:${prevStyles.inner}">
                            <div id="qr-nav-prev" class="nav-qr"></div>
                            <div>
                                <div class="nav-label">‚óÄ PREV</div>
                                <div class="nav-name">${prevSpool.display.replace(/^#\d+\s*/, '')}</div>
                            </div>
                        </div>
                    </div>
                    <div class="nav-card" style="background: ${nextStyles.frame}" onclick="nextBuffer()">
                        <div class="nav-inner" style="background-color:${nextStyles.inner}">
                            <div style="text-align:right;">
                                <div class="nav-label">NEXT ‚ñ∂</div>
                                <div class="nav-name">${nextSpool.display.replace(/^#\d+\s*/, '')}</div>
                            </div>
                            <div id="qr-nav-next" class="nav-qr"></div>
                        </div>
                    </div>
                `;
                generateSafeQR("qr-nav-prev", "CMD:PREV", 45);
                generateSafeQR("qr-nav-next", "CMD:NEXT", 45);
            } else {
                n.style.display = 'none';
            }
        }
    };
    
    const nextBuffer = () => { if(state.heldSpools.length > 1) { state.heldSpools.push(state.heldSpools.shift()); renderBuffer(); } };
    const prevBuffer = () => { if(state.heldSpools.length > 1) { state.heldSpools.unshift(state.heldSpools.pop()); renderBuffer(); } };
    
    const processScan = (text) => {
        const upper = text.toUpperCase();
        
        if (upper === 'CMD:DROP') { toggleDropMode(); return; }
        if (upper === 'CMD:EJECT') { toggleEjectMode(); return; }
        if (upper === 'CMD:UNDO') { triggerUndo(); return; }
        if (upper === 'CMD:CLEAR') { requestClearBuffer(); return; } 

        if (upper.startsWith('CMD:PRINT:')) { const parts = upper.split(':'); if(parts[2]) printLabel(parts[2]); return; }
        if (state.activeModal === 'safety') return upper.includes('CONFIRM') ? confirmSafety(true) : (upper.includes('CANCEL') ? confirmSafety(false) : null);
        if (state.activeModal === 'confirm') return upper.includes('CONFIRM') ? confirmAction(true) : (upper.includes('CANCEL') ? confirmAction(false) : null);
        if (state.activeModal === 'action') { if(upper.includes('CANCEL')) { closeModal('actionModal'); return; } if(upper.startsWith('CMD:MODAL:')) { closeModal('actionModal'); state.modalCallbacks[parseInt(upper.split(':')[2])](); return; } }
        if (upper.startsWith('CMD:TRASH:')) { const parts = upper.split(':'); if(parts[2] && document.getElementById('manageModal').classList.contains('show')) ejectSpool(parts[2], document.getElementById('manage-loc-id').value, false); return; }

        // --- AUDIT INTERCEPTION ---
        // If we are in Audit Mode, ONLY allow audit commands
        if (state.auditActive) {
            if (upper === 'CMD:DONE' || upper === 'CMD:AUDIT') {
                // Let these through to the server to end the session
            } else if (!upper.startsWith('ID:') && !upper.startsWith('CMD:')) {
                // Allow Location/Spool scans
            } else if (upper.startsWith('ID:')) {
                // Allow Spool scans
            } else {
                showToast("Cannot run commands in Audit Mode", "warning");
                return;
            }
        } else {
            // Normal Mode: Intercept AUDIT start
            if (upper === 'CMD:AUDIT') { 
                // Don't send CMD:AUDIT to server via identify_scan if logic handles it?
                // actually logic.py handles it. Let it pass.
            }
        }

        setProcessing(true);
        fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text}) }).then(r=>r.json()).then(res => {
            setProcessing(false);
            if (res.type === 'command') {
                const cmds = { 'clear': requestClearBuffer, 'undo': triggerUndo, 'eject': toggleEjectMode, 'next': nextBuffer, 'prev': prevBuffer, 'done': closeManage };
                if (cmds[res.cmd]) cmds[res.cmd](); else if (res.cmd === 'confirm' && state.pendingConfirm) confirmAction(true); else if (res.cmd === 'slot') handleSlotInteraction(res.value); else if (res.cmd === 'ejectall') triggerEjectAll(document.getElementById('manage-loc-id').value);
            } else if (res.type === 'location') {
                if (state.lastScannedLoc === res.id) { state.heldSpools = []; renderBuffer(); openManage(res.id); state.lastScannedLoc = null; return; }
                if (state.heldSpools.length > 0) { performContextAssign(res.id); state.lastScannedLoc = null; return; }
                const locData = state.allLocations.find(l => l.LocationID === res.id);
                if ((!locData || parseInt(locData['Max Spools']) <= 1) && res.contents && res.contents.length > 0) { const spool = res.contents[0]; state.heldSpools.unshift({id: spool.id, display: spool.display, color: spool.color}); renderBuffer(); showToast("‚ö° Quick Pick: #" + spool.id); state.lastScannedLoc = res.id; return; }
                openManage(res.id); state.lastScannedLoc = res.id;
            } else if (res.type === 'spool') {
                if (state.dropMode) { removeBufferItem(res.id); return; }
                if (state.ejectMode) { ejectSpool(res.id, "Scan", false); toggleEjectMode(); return; } 
                
                state.lastScannedLoc = null; 
                if (state.heldSpools.some(s=>s.id===res.id)) showToast("Already in Buffer", "warning");
                else { state.heldSpools.unshift({id:res.id, display:res.display, color:res.color}); renderBuffer(); }
            } else if (res.type === 'error') showToast(res.msg, 'error');
        }).catch(()=>setProcessing(false));
    };

    const performContextAssign = (tid) => {
        setProcessing(true); fetch('/api/smart_move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({location:tid, spools:[state.heldSpools[0].id]}) }).then(r=>r.json()).then(res=>{ setProcessing(false); if(res.status==='success') { showToast("Assigned!", "success"); state.heldSpools.shift(); renderBuffer(); if(document.getElementById('manage-loc-id').value===tid) refreshManageView(tid); } else showToast(res.msg, 'error'); }).catch(()=>setProcessing(false));
    };

    const closeModal = (id) => { modals[id].hide(); state.activeModal = null; };
    const requestConfirmation = (msg, cb) => { document.getElementById('confirm-msg').innerText=msg; state.pendingConfirm=cb; modals.confirmModal.show(); state.activeModal = 'confirm'; };
    const confirmAction = (y) => { closeModal('confirmModal'); if(y && state.pendingConfirm) state.pendingConfirm(); state.pendingConfirm=null; };
    const promptSafety = (msg, cb) => { document.getElementById('safety-msg').innerText=msg; state.pendingSafety=cb; modals.safetyModal.show(); state.activeModal = 'safety'; };
    const confirmSafety = (y) => { closeModal('safetyModal'); if(y && state.pendingSafety) state.pendingSafety(); state.pendingSafety=null; };
    const openLocationsModal = () => { modals.locMgrModal.show(); fetchLocations(); };
    const openManage = (id) => { document.getElementById('manageTitle').innerText=`Manage: ${id}`; document.getElementById('manage-loc-id').value=id; document.getElementById('manual-spool-id').value=""; if(refreshManageView(id)) modals.manageModal.show(); else showToast("Loc Error", "error"); };
    const closeManage = () => { modals.manageModal.hide(); fetchLocations(); };
    const fetchLocations = () => { fetch('/api/locations').then(r=>r.json()).then(d => { state.allLocations=d; document.getElementById('loc-count').innerText = d.length + " Locs"; document.getElementById('location-table').innerHTML = d.map(l => `<tr><td class="col-id">${l.LocationID}</td><td class="col-name">${l.Name}</td><td class="col-status">${l.Occupancy||''} <span class="badge bg-secondary">${l.Type}</span></td><td class="col-actions"><button class="btn btn-sm btn-outline-warning me-1 btn-edit" data-id="${l.LocationID}">‚úèÔ∏è</button><button class="btn btn-sm btn-outline-danger me-1 btn-delete" data-id="${l.LocationID}">üóëÔ∏è</button><button class="btn btn-sm btn-info btn-manage" data-id="${l.LocationID}">Manage</button></td></tr>`).join(''); }); };
    const refreshManageView = (id) => {
        const loc = state.allLocations.find(l=>l.LocationID==id); if(!loc) return false;
        const isGrid = (loc.Type==='Dryer Box' || loc.Type==='MMU Slot') && parseInt(loc['Max Spools']) > 1;
        document.getElementById('manage-grid-view').style.display = isGrid ? 'block' : 'none';
        document.getElementById('manage-list-view').style.display = isGrid ? 'none' : 'block';
        fetch(`/api/get_contents?id=${id}`).then(r=>r.json()).then(d => { if(isGrid) renderGrid(d, parseInt(loc['Max Spools'])); else renderList(d, id); });
        return true;
    };
    
    // --- RENDER GRID (Uses Gradient Engine) ---
    const renderGrid = (data, max) => {
        const grid=document.getElementById('slot-grid-container'), un=document.getElementById('unslotted-container');
        grid.innerHTML=""; un.innerHTML=""; state.currentGrid={};
        const unslotted=[];
        data.forEach(i => { if(i.slot && parseInt(i.slot)>0) state.currentGrid[i.slot]=i; else unslotted.push(i); });
        for(let i=1; i<=max; i++) {
            const item = state.currentGrid[i], div = document.createElement('div');
            
            if (item) {
                const styles = getFilamentStyle(item.color);
                div.className = "filament-frame slot-btn full";
                div.style.background = styles.frame;
                div.style.padding = "8px"; 
                div.innerHTML = `
                    <div class="filament-inner" style="background-color:${styles.inner}">
                        <div class="slot-left">
                            <div class="slot-num">Slot ${i}</div>
                            <div id="qr-slot-${i}" class="bg-white p-1 rounded"></div>
                        </div>
                        <div class="slot-right">
                            <div class="slot-content">${item.display}</div>
                            <button class="btn btn-sm btn-light border-dark mt-2 fw-bold" onclick="event.stopPropagation(); printLabel(${item.id})">üñ®Ô∏è LABEL</button>
                        </div>
                    </div>`;
            } else {
                div.className = "slot-btn empty";
                div.innerHTML = `<div class="slot-left"><div class="slot-num">Slot ${i}</div><div id="qr-slot-${i}" class="bg-white p-1 rounded"></div></div><div class="slot-right"><div class="text-muted fs-4">EMPTY</div></div>`;
            }
            div.onclick = () => handleSlotInteraction(i); grid.appendChild(div);
            generateSafeQR(`qr-slot-${i}`, "CMD:SLOT:"+i, 60);
        }
        if(unslotted.length>0) renderUnslotted(unslotted); else un.style.display='none';
    };

    // --- RENDER LIST (Uses Gradient Engine) ---
    const renderList = (data, locId) => {
        const list = document.getElementById('manage-contents-list');
        list.innerHTML = data.length===0 ? "<div class='text-center text-muted'>Empty</div>" : data.map((s,i) => renderBadgeHTML(s, i, locId)).join('');
        data.forEach((s,i) => renderBadgeQRs(s, i));
    };

    const renderUnslotted = (items) => {
        const un = document.getElementById('unslotted-container');
        un.style.display='block';
        un.innerHTML = items.map((s,i) => renderBadgeHTML(s, i, document.getElementById('manage-loc-id').value)).join('');
        items.forEach((s,i) => renderBadgeQRs(s, i));
        
        const dz = document.createElement('div'); dz.className='danger-zone'; dz.innerHTML=`<h4 class="text-danger fw-bold">DANGER ZONE</h4><div class="d-flex justify-content-center align-items-center gap-3"><div class="text-center"><div id="qr-eject-all" class="bg-white p-2 rounded"></div><div class="qr-label text-white">ALL</div></div><button class="btn btn-danger btn-lg fw-bold" onclick="triggerEjectAll('${document.getElementById('manage-loc-id').value}')">EJECT ALL üí•</button></div>`;
        un.appendChild(dz); generateSafeQR("qr-eject-all", "CMD:EJECTALL", 100);
    };

    const renderBadgeHTML = (s, i, locId) => {
        const styles = getFilamentStyle(s.color);
        return `
        <div class="unslotted-item filament-frame" style="background:${styles.frame}">
            <div class="item-card-inner" style="background-color: ${styles.inner}">
                <div class="item-info">${s.display}</div>
                <div class="item-actions">
                    <div class="action-badge" onclick="ejectSpool(${s.id}, '${locId}', true)">
                        <div id="qr-pick-${i}" class="badge-qr"></div>
                        <button class="badge-btn btn-pick">‚úã PICK</button>
                    </div>
                    <div class="action-badge" onclick="printLabel(${s.id})">
                        <div id="qr-print-${i}" class="badge-qr"></div>
                        <button class="badge-btn btn-print">üñ®Ô∏è PRINT</button>
                    </div>
                    <div class="action-badge" onclick="ejectSpool(${s.id}, '${locId}', false)">
                        <div id="qr-trash-${i}" class="badge-qr"></div>
                        <button class="badge-btn btn-trash">üóëÔ∏è TRASH</button>
                    </div>
                </div>
            </div>
        </div>`;
    };

    const renderBadgeQRs = (s, i) => {
        generateSafeQR(`qr-pick-${i}`, "ID:"+s.id, 46);
        generateSafeQR(`qr-print-${i}`, "CMD:PRINT:"+s.id, 46);
        generateSafeQR(`qr-trash-${i}`, "CMD:TRASH:"+s.id, 46);
    };

    const handleSlotInteraction = (slot) => {
        if(!document.getElementById('manageModal').classList.contains('show')) return;
        const locId = document.getElementById('manage-loc-id').value, item = state.currentGrid[slot];
        if (state.heldSpools.length > 0) {
            const newId = state.heldSpools[0].id;
            if(item) promptAction("Slot Occupied", `Swap/Overwrite Slot ${slot}?`, [{label:"Swap", action:()=>{state.heldSpools.shift(); state.heldSpools.push({id:item.id, display:item.display, color:item.color}); renderBuffer(); doAssign(locId, newId, slot);}}, {label:"Overwrite", action:()=>{state.heldSpools.shift(); renderBuffer(); doAssign(locId, newId, slot);}}]);
            else { state.heldSpools.shift(); renderBuffer(); doAssign(locId, newId, slot); }
        } else if(item) promptAction("Slot Action", `Manage ${item.display}`, [{label:"‚úã Pick Up", action:()=>{state.heldSpools.unshift({id:item.id, display:item.display, color:item.color}); renderBuffer(); doEject(item.id, locId, false);}}, {label:"üóëÔ∏è Eject", action:()=>{doEject(item.id, locId, false);}}, {label:"üñ®Ô∏è Print Label", action:()=>{printLabel(item.id);}}]);
    };
    const promptAction = (t, m, btns) => {
        document.getElementById('action-title').innerText=t; document.getElementById('action-msg').innerHTML=m; state.modalCallbacks=[];
        document.getElementById('action-buttons').innerHTML = btns.map((b,i) => { state.modalCallbacks.push(b.action); return `<div class="modal-action-card" onclick="closeModal('actionModal');state.modalCallbacks[${i}]()"><div id="qr-act-${i}" class="bg-white p-1 rounded mb-2"></div><button class="btn btn-primary modal-action-btn">${b.label}</button></div>`; }).join('');
        btns.forEach((_,i) => generateSafeQR(`qr-act-${i}`, `CMD:MODAL:${i}`, 100));
        modals.actionModal.show(); state.activeModal = 'action';
    };
    const doAssign = (loc, spool, slot) => { setProcessing(true); fetch('/api/manage_contents', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'add', location:loc, spool_id:"ID:"+spool, slot})}).then(r=>r.json()).then(res=>{setProcessing(false); if(res.status==='success') { showToast("Assigned"); refreshManageView(loc); } else showToast(res.msg, 'error');}).catch(()=>setProcessing(false)); };
    const ejectSpool = (sid, loc, pickup) => { if(pickup) { fetch('/api/identify_scan', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text:"ID:"+sid})}).then(r=>r.json()).then(res=>{ if(res.type==='spool'){ if(state.heldSpools.some(s=>s.id===res.id)) showToast("In Buffer"); else { state.heldSpools.unshift({id:res.id, display:res.display, color:res.color}); renderBuffer(); } doEject(sid, loc); } }); } else { if(loc!=="Scan") requestConfirmation(`Eject spool #${sid}?`, ()=>doEject(sid, loc)); else doEject(sid, loc); } };
    const doEject = (sid, loc) => { setProcessing(true); fetch('/api/manage_contents', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'remove', location:loc, spool_id:sid})}).then(r=>r.json()).then(()=>{ setProcessing(false); showToast("Ejected"); if(loc!=="Scan") refreshManageView(loc); }).catch(()=>setProcessing(false)); };
    const manualAddSpool = () => {
        const val = document.getElementById('manual-spool-id').value.trim(); if (!val) return; setProcessing(true);
        fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: val}) }).then(r => r.json()).then(res => {
            setProcessing(false); document.getElementById('manual-spool-id').value = ""; document.getElementById('manual-spool-id').focus();
            if (res.type === 'spool') { if (state.heldSpools.some(s=>s.id===res.id)) showToast("Already in Buffer", "warning"); else { state.heldSpools.unshift({id:res.id, display:res.display, color:res.color}); renderBuffer(); showToast("Added to Buffer"); }} else showToast(res.msg || "Invalid Code", 'warning');
        }).catch(() => setProcessing(false));
    };
    const triggerEjectAll = (loc) => promptSafety(`Nuke all unslotted in ${loc}?`, () => { setProcessing(true); fetch('/api/manage_contents', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'clear_location', location:loc})}).then(r=>r.json()).then(()=>{setProcessing(false); refreshManageView(loc); showToast("Cleared!");}); });
    const openEdit = (id) => { const i=state.allLocations.find(l=>l.LocationID==id); if(i){ modals.locMgrModal.hide(); document.getElementById('edit-original-id').value=id; document.getElementById('edit-id').value=id; document.getElementById('edit-name').value=i.Name; document.getElementById('edit-type').value=i.Type; document.getElementById('edit-max').value=i['Max Spools']; modals.locModal.show(); }};
    const closeEdit = () => { modals.locModal.hide(); modals.locMgrModal.show(); };
    const saveLocation = () => { fetch('/api/locations', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({old_id:document.getElementById('edit-original-id').value, new_data:{LocationID:document.getElementById('edit-id').value, Name:document.getElementById('edit-name').value, Type:document.getElementById('edit-type').value, "Max Spools":document.getElementById('edit-max').value}})}).then(()=>{modals.locModal.hide(); modals.locMgrModal.show(); fetchLocations();}); };
    const openAddModal = () => { modals.locMgrModal.hide(); document.getElementById('edit-original-id').value=""; document.getElementById('edit-id').value=""; document.getElementById('edit-name').value=""; document.getElementById('edit-max').value="1"; modals.locModal.show(); };
    const deleteLoc = (id) => requestConfirmation(`Delete ${id}?`, () => fetch(`/api/locations?id=${id}`, {method:'DELETE'}).then(fetchLocations));
    const triggerUndo = () => fetch('/api/undo', {method:'POST'}).then(updateLogState);
    
    const updateLogState = () => {
        if(!state.logsPaused) fetch('/api/logs').then(r=>r.json()).then(d=>{ 
            document.getElementById('live-logs').innerHTML = d.logs.map(l=>`<div class="log-${l.type}">[${l.time}] ${l.msg}</div>`).join(''); 
            document.getElementById('undo-btn').disabled=!d.undo_available; 
            document.getElementById('st-spoolman').className=`status-dot ${d.status.spoolman?'status-on':'status-off'}`; 
            document.getElementById('st-filabridge').className=`status-dot ${d.status.filabridge?'status-on':'status-off'}`;
            
            state.auditActive = d.audit_active;
            if (state.auditActive !== state.lastAuditState) {
                state.lastAuditState = state.auditActive;
                const btn = document.getElementById('btn-audit'); // LOOK FOR ID
                const deckBtn = document.getElementById('btn-deck-audit'); // NEW DECK ID
                const lbl = document.getElementById('lbl-audit');
                const qrDiv = document.getElementById('qr-audit');
                
                // Update BOTH buttons if they exist
                if (state.auditActive) {
                    if(btn) btn.classList.add('btn-active-audit'); 
                    if(deckBtn) deckBtn.classList.add('btn-audit-active'); // Use new deck class
                    if(lbl) { lbl.innerText = "FINISH"; lbl.classList.add('label-active-audit'); }
                    if(qrDiv) { qrDiv.innerHTML=""; generateSafeQR('qr-audit', "CMD:DONE", 120); }
                } else {
                    if(btn) btn.classList.remove('btn-active-audit');
                    if(deckBtn) deckBtn.classList.remove('btn-audit-active');
                    if(lbl) { lbl.innerText = "AUDIT MODE"; lbl.classList.remove('label-active-audit'); }
                    if(qrDiv) { qrDiv.innerHTML=""; generateSafeQR('qr-audit', "CMD:AUDIT", 120); }
                }
            }
        });
    };
    setInterval(updateLogState, 2500);
</script>