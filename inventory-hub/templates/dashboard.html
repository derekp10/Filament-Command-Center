<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Command Center {{ version }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- HIGH CONTRAST THEME --- */
        body { background-color: #000; color: #fff; font-family: 'Segoe UI', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .navbar { background-color: #111; border-bottom: 2px solid #00d4ff; flex-shrink: 0; }
        .navbar-brand { color: #00d4ff !important; font-weight: bold; font-size: 1.5rem; }
        
        /* Layout & Utilities */
        .main-container { flex-grow: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
        .col-logs, .col-buffer { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        .log-box { flex-grow: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 1.1rem; color: #eee; white-space: pre-wrap; word-break: break-all; }
        .log-INFO { color: #0f0; } .log-WARNING { color: #fc0; } .log-ERROR { color: #f44; }
        
        /* Buffer Zone */
        .buffer-header { padding: 15px; background: #222; border-bottom: 1px solid #333; color: #00d4ff; font-weight: bold; display: flex; justify-content: space-between; }
        .buffer-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .buffer-item { background: #222; border: 1px solid #555; border-radius: 8px; margin-bottom: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; opacity: 0.8; }
        .buffer-item.active-item { border: 2px solid #0f0; opacity: 1; background: #2a2a2a; box-shadow: 0 0 10px rgba(0,255,0,0.2); }
        .buffer-swatch { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; flex-shrink: 0; }
        .buffer-text { font-size: 1.6rem; font-weight: bold; margin-left: 15px; }
        .buffer-info { display: flex; align-items: center; }

        /* QR & Commands */
        .qr-box { background: white; padding: 5px; border-radius: 4px; }
        .cmd-deck { padding: 15px; background: #1a1a1a; border-top: 1px solid #333; display: flex; justify-content: space-around; }
        .cmd-btn { cursor: pointer; transition: 0.2s; border-radius: 8px; padding: 10px; text-align: center; }
        .cmd-btn:active { background: #333; transform: scale(0.95); }
        .qr-label { font-size: 0.9rem; color: #ccc; font-weight: bold; text-transform: uppercase; margin-top: 5px; }

        /* Modals & Z-Index Pyramid */
        .modal-content { background: #121212; color: #fff; border: 1px solid #555; }
        #locMgrModal, #locModal { z-index: 1055; } /* Level 1 */
        #manageModal { z-index: 1065; } /* Level 2 */
        #actionModal, #safetyModal, #confirmModal { z-index: 1075; } /* Level 3 (Top) */

        /* Slots Grid */
        .slot-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .slot-btn { background: #222; border: 2px solid #444; border-radius: 10px; height: 180px; display: flex; align-items: center; justify-content: space-between; padding: 10px; cursor: pointer; position: relative; overflow: hidden; }
        .slot-btn.full { border-color: #00d4ff; background: #1a1a1a; }
        .slot-swatch { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; flex-shrink: 0; margin-bottom: 5px; }
        .slot-content { font-size: 1.2rem; font-weight: bold; word-break: break-word; }
        
        /* Unslotted List */
        .unslotted-box { border: 2px solid #fc0; background: #1a1a1a; padding: 10px; margin-top: 20px; border-radius: 8px; }
        .unslotted-item { background: #252525; padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        .control-group { display: flex; align-items: center; gap: 20px; background: #111; padding: 10px 20px; border-radius: 8px; border: 1px solid #333; }

        /* Heads Up & Nav */
        .headsup-strip { background: #111; border-bottom: 1px solid #333; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-deck { display: flex; justify-content: space-between; padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; gap: 20px; }
        .nav-card { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 15px 20px; display: flex; align-items: center; cursor: pointer; flex: 1; justify-content: center; transition: 0.2s; }
        .nav-card:active { background: #444; transform: translateY(2px); }
        
        /* Status & Overlays */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-on { background: #0f0; box-shadow: 0 0 5px #0f0; } .status-off { background: #f44; box-shadow: 0 0 5px #f44; }
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 11000; text-align: center; width: 80%; max-width: 600px; }
        .toast-msg { background: rgba(0,0,0,0.95); color: #fff; padding: 30px; border: 4px solid #00d4ff; border-radius: 12px; font-size: 2rem; font-weight: bold; }
        #processing-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000; display: none; justify-content: center; align-items: center; cursor: wait; }
        #focus-guard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 12000; display: none; justify-content: center; align-items: center; border: 20px solid #f44; text-align: center; }
    </style>
</head>
<body>
    <div id="focus-guard" onclick="document.body.focus()"><div><div style="font-size:5rem;">üö´</div><div style="font-size:3rem;color:#f44;font-weight:bold;">SCANNER PAUSED</div><div class="text-white">Click anywhere to resume</div></div></div>
    <div id="processing-overlay"><div class="spinner-border text-info" style="width: 5rem; height: 5rem;" role="status"></div></div>
    <div id="toast-container"></div>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <div class="d-flex align-items-center"><span class="navbar-brand">Filament Command Center</span><span class="version-tag">{{ version }}</span></div>
            <div class="d-flex align-items-center">
                <div style="margin-right:20px; color:#ccc;"><span id="st-spoolman" class="status-dot status-off"></span> Spoolman</div>
                <div style="margin-right:20px; color:#ccc;"><span id="st-filabridge" class="status-dot status-off"></span> FilaBridge</div>
                <button class="btn btn-outline-info btn-sm me-3" onclick="openLocationsModal()">üìÇ Locations</button>
                <button onclick="triggerUndo()" class="btn btn-warning btn-sm me-3" id="undo-btn" disabled>‚Ü©Ô∏è UNDO</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="col-logs">
            <div class="p-3 border-bottom border-secondary text-info fw-bold d-flex justify-content-between">
                <span>Live Activity üì°</span><span id="log-status" class="small text-muted">Auto-Refresh ON</span>
            </div>
            <div id="live-logs" class="log-box" onmouseenter="pauseLogs(true)" onmouseleave="pauseLogs(false)"></div>
        </div>
        <div class="col-buffer">
            <div class="buffer-header"><span>BUFFER ZONE</span><span id="scan-status" style="font-size:1rem; color:#888;">Ready...</span></div>
            <div id="buffer-zone" class="buffer-content"></div>
            <div class="cmd-deck">
                <div class="cmd-btn" onclick="processScan('CMD:CLEAR')"><div class="qr-box" id="qr-clear"></div><div class="qr-label">CLEAR</div></div>
                <div class="cmd-btn" onclick="triggerUndo()"><div class="qr-box" id="qr-undo"></div><div class="qr-label">UNDO</div></div>
                <div class="cmd-btn" onclick="processScan('CMD:EJECT')"><div class="qr-box" id="qr-eject"></div><div class="qr-label">EJECT MODE</div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locMgrModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Location Manager</h5><div class="ms-auto text-muted" id="loc-count">0 Locs</div><button class="btn btn-success btn-lg ms-3" onclick="openAddModal()">+ New Slot</button><button type="button" class="btn-close btn-close-white ms-3" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><table class="table table-hover table-dark mb-0" style="font-size:1.1rem;"><thead><tr><th>ID</th><th>Name</th><th>Status</th><th class="text-end">Actions</th></tr></thead><tbody id="location-table"></tbody></table></div></div></div></div>
    
    <div class="modal fade" id="manageModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header p-2 bg-dark border-bottom border-secondary"><h5 class="modal-title ms-3" id="manageTitle">Manage</h5><button type="button" class="btn-close btn-close-white me-2" onclick="closeManage()"></button></div>
        <div id="headsup-buffer" class="headsup-strip" style="display:none;"><div class="d-flex align-items-center"><span class="me-3 text-warning fw-bold fs-4">‚úã READY:</span><div id="headsup-swatch" class="buffer-swatch me-3"></div><span id="headsup-text" class="text-white fw-bold fs-3"></span></div><div class="fs-4 fw-bold text-info border border-info px-3 py-1 rounded" id="headsup-total">Buffer: 0</div></div>
        <div id="buffer-nav-deck" class="nav-deck" style="display:none;"><div class="nav-card" onclick="prevBuffer()"><div id="qr-prev" class="bg-white p-1 rounded me-3" style="width:50px;height:50px;"></div><div class="text-start"><div class="fw-bold fs-4">< PREV</div></div></div><div class="nav-card" onclick="nextBuffer()"><div class="text-end me-3"><div class="fw-bold fs-4">NEXT ></div></div><div id="qr-next" class="bg-white p-1 rounded" style="width:50px;height:50px;"></div></div></div>
        <div class="modal-body">
            <div id="manage-grid-view" style="display:none;"><div class="alert alert-info py-1 mb-2 small text-center">Tap button or scan slot QR (CMD:SLOT:X)</div><div id="slot-grid-container" class="slot-grid"></div><div id="unslotted-container" style="display:none;"></div></div>
            <div id="manage-list-view"><div id="manage-contents-list" class="mb-4"></div></div>
            <hr class="border-secondary"><div class="input-group mb-3"><input type="text" id="manual-spool-id" class="form-control form-control-lg" placeholder="Enter Spool ID / Scan Legacy"><button class="btn btn-primary btn-lg" onclick="manualAddSpool()">‚ûï Add</button></div>
            <div class="d-flex justify-content-between align-items-center bg-dark p-2 rounded border border-secondary"><button class="btn btn-success btn-lg flex-grow-1 me-3" onclick="closeManage()">‚úÖ Done / Sync</button><div class="text-center"><div id="qr-done" class="bg-white p-1 rounded" style="cursor:pointer;" onclick="closeManage()"></div><div class="qr-label">DONE</div></div></div>
            <input type="hidden" id="manage-loc-id">
        </div></div></div></div>
    
    <div class="modal fade" id="actionModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="border: 2px solid #00d4ff;"><div class="modal-header bg-dark"><h5 class="modal-title fw-bold" id="action-title">Action Needed</h5></div><div class="modal-body text-center"><p id="action-msg" class="fs-3 mb-4"></p><div id="action-buttons" class="modal-action-row d-flex justify-content-center gap-5 flex-wrap"></div></div><div class="modal-footer justify-content-center"><div class="text-center"><div id="qr-modal-cancel" class="bg-white p-1 rounded mb-1 d-inline-block"></div><br><button class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelAction()">‚ùå Cancel</button></div></div></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="border: 4px solid #fc0;"><div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold">‚ö†Ô∏è CONFIRMATION</h5></div><div class="modal-body text-center"><p id="confirm-msg" class="fs-2 fw-bold mb-4"></p><div class="d-flex justify-content-center gap-5 mt-4"><div class="text-center" onclick="confirmAction(false)" style="cursor:pointer"><div id="qr-confirm-no" class="bg-white p-2 rounded mb-2"></div><button class="btn btn-secondary btn-lg">‚ùå NO</button></div><div class="text-center" onclick="confirmAction(true)" style="cursor:pointer"><div id="qr-confirm-yes" class="bg-white p-2 rounded mb-2"></div><button class="btn btn-success btn-lg">‚úÖ YES</button></div></div></div></div></div></div>
    <div class="modal fade" id="safetyModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="border: 4px solid #f44;"><div class="modal-header bg-danger text-white"><h5 class="modal-title fw-bold">‚ö†Ô∏è SAFETY CONFIRMATION</h5></div><div class="modal-body text-center"><p id="safety-msg" class="fs-2 fw-bold mb-4"></p><div class="d-flex justify-content-center gap-5 mt-4"><div class="text-center" onclick="confirmSafety(false)" style="cursor:pointer"><div id="qr-safety-no" class="bg-white p-2 rounded mb-2"></div><button class="btn btn-secondary btn-lg">‚ùå NO</button></div><div class="text-center" onclick="confirmSafety(true)" style="cursor:pointer"><div id="qr-safety-yes" class="bg-white p-2 rounded mb-2"></div><button class="btn btn-danger btn-lg">‚úÖ YES</button></div></div></div></div></div></div>
    <div class="modal fade" id="locModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle">Edit Location</h5><button type="button" class="btn-close btn-close-white" onclick="closeEdit()"></button></div><div class="modal-body"><input type="hidden" id="edit-original-id"><div class="mb-3"><label>Location ID</label><input type="text" class="form-control" id="edit-id"></div><div class="mb-3"><label>Friendly Name</label><input type="text" class="form-control" id="edit-name"></div><div class="row"><div class="col-8 mb-3"><label>Type</label><select class="form-select" id="edit-type"><option value="Dryer Box">Dryer Box</option><option value="Cart">Cart</option><option value="Shelf">Shelf</option><option value="Printer">Printer</option><option value="MMU Slot">MMU Slot</option></select></div><div class="col-4 mb-3"><label>Max Spools</label><input type="number" class="form-control" id="edit-max"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeEdit()">Cancel</button><button type="button" class="btn btn-primary" onclick="saveLocation()">Save</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const DASHBOARD_VERSION = "v149.0";
        console.log("üöÄ Filament Command Center Dashboard Loaded: " + DASHBOARD_VERSION);

        let modals = {}; // Store modal instances
        let state = { scanBuffer: "", bufferTimeout: null, heldSpools: [], ejectMode: false, lastScannedLoc: null, pendingConfirm: null, pendingSafety: null, allLocations: [], logsPaused: false, currentGrid: {}, processing: false, modalCallbacks: [] };

        document.addEventListener('DOMContentLoaded', () => {
            // Init Modals
            ['locMgrModal', 'locModal', 'manageModal', 'confirmModal', 'actionModal', 'safetyModal'].forEach(id => modals[id] = new bootstrap.Modal(document.getElementById(id)));
            
            // Init QRs
            const qrs = { 'qr-undo': 'CMD:UNDO', 'qr-clear': 'CMD:CLEAR', 'qr-eject': 'CMD:EJECT', 'qr-safety-yes': 'CMD:CONFIRM', 'qr-safety-no': 'CMD:CANCEL', 'qr-confirm-yes': 'CMD:CONFIRM', 'qr-confirm-no': 'CMD:CANCEL', 'qr-modal-cancel': 'CMD:MODAL:CANCEL', 'qr-done': 'CMD:DONE', 'qr-prev': 'CMD:PREV', 'qr-next': 'CMD:NEXT' };
            for(const [id, txt] of Object.entries(qrs)) new QRCode(document.getElementById(id), {text: txt, width: document.getElementById(id).style.width?.replace('px','') || 120, height: document.getElementById(id).style.height?.replace('px','') || 120});

            // Event Delegation for Table (The Fix for Dead Buttons)
            document.getElementById('location-table').addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-manage');
                if (btn) openManage(btn.dataset.id);
                else if (e.target.closest('.btn-edit')) openEdit(e.target.closest('.btn-edit').dataset.id);
                else if (e.target.closest('.btn-delete')) deleteLoc(e.target.closest('.btn-delete').dataset.id);
            });

            document.getElementById("manual-spool-id").addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); manualAddSpool(); }});
        });

        // Focus Guard
        window.addEventListener('blur', () => document.getElementById('focus-guard').style.display = 'flex');
        window.addEventListener('focus', () => document.getElementById('focus-guard').style.display = 'none');
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('focus-guard').style.display === 'flex' || state.processing || e.target.tagName === 'INPUT') return;
            if (e.key === 'Enter') { e.preventDefault(); if (state.scanBuffer.length > 0) processScan(state.scanBuffer); state.scanBuffer = ""; }
            else if (e.key.length === 1) { state.scanBuffer += e.key; clearTimeout(state.bufferTimeout); state.bufferTimeout = setTimeout(() => state.scanBuffer = "", 2000); }
        });

        const setProcessing = (s) => { state.processing = s; document.getElementById('processing-overlay').style.display = s ? 'flex' : 'none'; };
        const showToast = (msg, type='info') => {
            const el = document.createElement('div'); el.className = 'toast-msg'; el.innerText = msg; el.style.borderColor = type==='error'?'#f44':(type==='warning'?'#fc0':'#00d4ff');
            document.getElementById('toast-container').appendChild(el); setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 2000);
        };

        // Buffer Logic
        const renderBuffer = () => {
            const z = document.getElementById('buffer-zone'), h = document.getElementById('headsup-buffer'), n = document.getElementById('buffer-nav-deck');
            if (state.heldSpools.length === 0) {
                z.innerHTML = `<div class="text-center text-muted mt-5"><h3>Buffer Empty</h3></div>`; h.style.display = n.style.display = 'none'; return;
            }
            z.innerHTML = state.heldSpools.map((s, i) => `<div class="buffer-item ${i===0?'active-item':''}"><div class="buffer-info"><div class="buffer-swatch" style="background-color:#${s.color}"></div><div class="buffer-text">${s.display}</div></div><div id="qr-buf-${i}" class="qr-box"></div></div>`).join('');
            state.heldSpools.forEach((s, i) => new QRCode(document.getElementById(`qr-buf-${i}`), {text: "ID:"+s.id, width:120, height:120}));
            h.style.display = 'flex'; document.getElementById('headsup-swatch').style.backgroundColor = `#${state.heldSpools[0].color}`;
            document.getElementById('headsup-text').innerText = state.heldSpools[0].display; document.getElementById('headsup-total').innerText = `Buffer: ${state.heldSpools.length}`;
            n.style.display = state.heldSpools.length > 1 ? 'flex' : 'none';
        };
        const nextBuffer = () => { if(state.heldSpools.length > 1) { state.heldSpools.push(state.heldSpools.shift()); renderBuffer(); } };
        const prevBuffer = () => { if(state.heldSpools.length > 1) { state.heldSpools.unshift(state.heldSpools.pop()); renderBuffer(); } };

        // Scanning & API
        const processScan = (text) => {
            const upper = text.toUpperCase();
            if (document.getElementById('safetyModal').classList.contains('show')) return upper.includes('CONFIRM') ? confirmSafety(true) : (upper.includes('CANCEL') ? confirmSafety(false) : null);
            if (document.getElementById('confirmModal').classList.contains('show')) return upper.includes('CONFIRM') ? confirmAction(true) : (upper.includes('CANCEL') ? confirmAction(false) : null);
            if (document.getElementById('actionModal').classList.contains('show')) return upper.includes('CANCEL') ? modals.actionModal.hide() : (upper.startsWith('CMD:MODAL:') ? modalCallbacks[parseInt(upper.split(':')[2])]() : null);
            if (upper.startsWith('CMD:TRASH:')) { const parts = upper.split(':'); if(parts[2] && document.getElementById('manageModal').classList.contains('show')) ejectSpool(parts[2], document.getElementById('manage-loc-id').value, false); return; }

            setProcessing(true);
            fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text}) }).then(r=>r.json()).then(res => {
                setProcessing(false);
                if (res.type === 'command') {
                    const cmds = { 'clear': ()=>{state.heldSpools=[];renderBuffer();showToast("Buffer Cleared");}, 'undo': triggerUndo, 'eject': ()=>{showToast("EJECT MODE", "warning");state.ejectMode=true;}, 'next': nextBuffer, 'prev': prevBuffer, 'done': closeManage };
                    if (cmds[res.cmd]) cmds[res.cmd]();
                    else if (res.cmd === 'confirm' && state.pendingConfirm) confirmAction(true);
                    else if (res.cmd === 'slot') handleSlotInteraction(res.value);
                    else if (res.cmd === 'ejectall') triggerEjectAll(document.getElementById('manage-loc-id').value);
                } else if (res.type === 'location') {
                    if (state.heldSpools.length > 0) performContextAssign(res.id); else openManage(res.id);
                } else if (res.type === 'spool') {
                    if (state.ejectMode) { ejectSpool(res.id, "Scan", false); state.ejectMode = false; }
                    else if (state.heldSpools.some(s=>s.id===res.id)) showToast("Already in Buffer", "warning");
                    else { state.heldSpools.unshift({id:res.id, display:res.display, color:res.color}); renderBuffer(); }
                } else if (res.type === 'error') showToast(res.msg, 'error');
            }).catch(()=>setProcessing(false));
        };

        const performContextAssign = (tid) => {
            setProcessing(true);
            fetch('/api/smart_move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({location:tid, spools:[state.heldSpools[0].id]}) }).then(r=>r.json()).then(res=>{
                setProcessing(false);
                if(res.status==='success') { showToast("Assigned!", "success"); state.heldSpools.shift(); renderBuffer(); if(document.getElementById('manage-loc-id').value===tid) refreshManageView(tid); }
                else showToast(res.msg, 'error');
            }).catch(()=>setProcessing(false));
        };

        // Modals & Actions
        const requestConfirmation = (msg, cb) => { document.getElementById('confirm-msg').innerText=msg; state.pendingConfirm=cb; modals.confirmModal.show(); };
        const confirmAction = (y) => { modals.confirmModal.hide(); if(y && state.pendingConfirm) state.pendingConfirm(); state.pendingConfirm=null; };
        const promptSafety = (msg, cb) => { document.getElementById('safety-msg').innerText=msg; state.pendingSafety=cb; modals.safetyModal.show(); };
        const confirmSafety = (y) => { modals.safetyModal.hide(); if(y && state.pendingSafety) state.pendingSafety(); state.pendingSafety=null; };
        
        const openLocationsModal = () => { modals.locMgrModal.show(); fetchLocations(); };
        const openManage = (id) => { 
            document.getElementById('manageTitle').innerText=`Manage: ${id}`; document.getElementById('manage-loc-id').value=id; document.getElementById('manual-spool-id').value="";
            if(refreshManageView(id)) modals.manageModal.show(); else showToast("Loc Error", "error");
        };
        const closeManage = () => { modals.manageModal.hide(); fetchLocations(); };

        // Data Ops
        const fetchLocations = () => {
            fetch('/api/locations').then(r=>r.json()).then(d => {
                state.allLocations=d; document.getElementById('loc-count').innerText = d.length + " Locs";
                document.getElementById('location-table').innerHTML = d.map(l => `<tr><td style="color:#00d4ff;font-weight:bold;">${l.LocationID}</td><td>${l.Name}</td><td>${l.Occupancy||''} <span class="badge bg-secondary">${l.Type}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-warning me-1 btn-edit" data-id="${l.LocationID}">‚úèÔ∏è</button><button class="btn btn-sm btn-outline-danger me-1 btn-delete" data-id="${l.LocationID}">üóëÔ∏è</button><button class="btn btn-sm btn-info btn-manage" data-id="${l.LocationID}">Manage</button></td></tr>`).join('');
            });
        };

        const refreshManageView = (id) => {
            const loc = state.allLocations.find(l=>l.LocationID==id); if(!loc) return false;
            const isGrid = (loc.Type==='Dryer Box' || loc.Type==='MMU Slot') && parseInt(loc['Max Spools']) > 1;
            document.getElementById('manage-grid-view').style.display = isGrid ? 'block' : 'none';
            document.getElementById('manage-list-view').style.display = isGrid ? 'none' : 'block';
            fetch(`/api/get_contents?id=${id}`).then(r=>r.json()).then(d => {
                if(isGrid) renderGrid(d, parseInt(loc['Max Spools'])); else renderList(d, id);
            });
            return true;
        };

        const renderGrid = (data, max) => {
            const grid=document.getElementById('slot-grid-container'), un=document.getElementById('unslotted-container');
            grid.innerHTML=""; un.innerHTML=""; state.currentGrid={};
            const unslotted=[];
            data.forEach(i => { if(i.slot && parseInt(i.slot)>0) state.currentGrid[i.slot]=i; else unslotted.push(i); });

            for(let i=1; i<=max; i++) {
                const item = state.currentGrid[i], div = document.createElement('div');
                div.className = item ? "slot-btn full" : "slot-btn empty";
                div.innerHTML = `<div class="d-flex flex-column align-items-center w-50"><div class="slot-num">Slot ${i}</div><div id="qr-slot-${i}" class="bg-white p-1 rounded"></div></div><div class="d-flex flex-column align-items-center w-50 text-center">${item?`<div class="slot-swatch" style="background-color:#${item.color}"></div><div class="slot-content">${item.display}</div>`:`<div class="text-muted fs-4">EMPTY</div>`}</div>`;
                div.onclick = () => handleSlotInteraction(i); grid.appendChild(div);
                new QRCode(document.getElementById(`qr-slot-${i}`), {text:"CMD:SLOT:"+i, width:60, height:60});
            }
            if(unslotted.length>0) {
                un.style.display='block';
                unslotted.forEach((item, i) => {
                    const div = document.createElement('div'); div.className = "unslotted-item";
                    div.innerHTML = `<div class="d-flex align-items-center"><div class="buffer-swatch me-3" style="background-color:#${item.color}"></div><span class="fs-5 fw-bold">${item.display}</span></div><div class="control-group"><div class="text-center"><div id="qr-pick-${i}" class="bg-white p-1 rounded"></div><div class="qr-label">PICK</div></div><button class="btn btn-primary fw-bold" onclick="ejectSpool(${item.id}, '${document.getElementById('manage-loc-id').value}', true)">‚úã</button><button class="btn btn-danger fw-bold" onclick="ejectSpool(${item.id}, '${document.getElementById('manage-loc-id').value}', false)">üóëÔ∏è</button><div class="text-center"><div id="qr-trash-${i}" class="bg-white p-1 rounded"></div><div class="qr-label">TRASH</div></div></div>`;
                    un.appendChild(div); new QRCode(document.getElementById(`qr-pick-${i}`), {text:"ID:"+item.id, width:50, height:50}); new QRCode(document.getElementById(`qr-trash-${i}`), {text:"CMD:TRASH:"+item.id, width:50, height:50});
                });
                const dz = document.createElement('div'); dz.className='danger-zone'; dz.innerHTML=`<h4 class="text-danger fw-bold">DANGER ZONE</h4><div class="d-flex justify-content-center align-items-center gap-3"><div class="text-center"><div id="qr-eject-all" class="bg-white p-2 rounded"></div><div class="qr-label text-white">ALL</div></div><button class="btn btn-danger btn-lg fw-bold" onclick="triggerEjectAll('${document.getElementById('manage-loc-id').value}')">EJECT ALL üí•</button></div>`;
                un.appendChild(dz); new QRCode(document.getElementById("qr-eject-all"), {text:"CMD:EJECTALL", width:100, height:100});
            } else un.style.display='none';
        };

        const renderList = (data, locId) => {
            const list = document.getElementById('manage-contents-list');
            list.innerHTML = data.length===0 ? "<div class='text-center text-muted'>Empty</div>" : data.map((s,i) => `<div class="unslotted-item"><div class="d-flex align-items-center"><div id="qr-list-${i}" class="bg-white p-1 me-3 rounded"></div><div class="buffer-swatch me-3" style="background-color:#${s.color}"></div><span class="fs-4 fw-bold">${s.display}</span></div><div class="d-flex gap-2"><button class="btn btn-primary fw-bold" onclick="ejectSpool(${s.id}, '${locId}', true)">‚úã PICK</button><button class="btn btn-outline-danger" onclick="ejectSpool(${s.id}, '${locId}', false)">üóëÔ∏è</button></div></div>`).join('');
            data.forEach((s,i) => new QRCode(document.getElementById(`qr-list-${i}`), {text:"ID:"+s.id, width:60, height:60}));
        };

        const handleSlotInteraction = (slot) => {
            if(!document.getElementById('manageModal').classList.contains('show')) return;
            const locId = document.getElementById('manage-loc-id').value, item = state.currentGrid[slot];
            if (state.heldSpools.length > 0) {
                const newId = state.heldSpools[0].id;
                if(item) promptAction("Slot Occupied", `Swap/Overwrite Slot ${slot}?`, [{label:"Swap", action:()=>{state.heldSpools.shift(); state.heldSpools.push({id:item.id, display:item.display, color:item.color}); renderBuffer(); doAssign(locId, newId, slot);}}, {label:"Overwrite", action:()=>{state.heldSpools.shift(); renderBuffer(); doAssign(locId, newId, slot);}}]);
                else { state.heldSpools.shift(); renderBuffer(); doAssign(locId, newId, slot); }
            } else if(item) promptAction("Slot Action", `Manage ${item.display}`, [{label:"‚úã Pick Up", action:()=>{state.heldSpools.unshift({id:item.id, display:item.display, color:item.color}); renderBuffer(); doEject(item.id, locId, false);}}, {label:"üóëÔ∏è Eject", action:()=>{doEject(item.id, locId, false);}}]);
        };

        const promptAction = (t, m, btns) => {
            document.getElementById('action-title').innerText=t; document.getElementById('action-msg').innerHTML=m; state.modalCallbacks=[];
            document.getElementById('action-buttons').innerHTML = btns.map((b,i) => { state.modalCallbacks.push(b.action); return `<div class="modal-action-card" onclick="modals.actionModal.hide();state.modalCallbacks[${i}]()"><div id="qr-act-${i}" class="bg-white p-1 rounded mb-2"></div><button class="btn btn-primary modal-action-btn">${b.label}</button></div>`; }).join('');
            btns.forEach((_,i) => new QRCode(document.getElementById(`qr-act-${i}`), {text:`CMD:MODAL:${i}`, width:100, height:100}));
            modals.actionModal.show();
        };

        const doAssign = (loc, spool, slot) => { setProcessing(true); fetch('/api/manage_contents', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'add', location:loc, spool_id:"ID:"+spool, slot})}).then(r=>r.json()).then(res=>{setProcessing(false); if(res.status==='success') { showToast("Assigned"); refreshManageView(loc); } else showToast(res.msg, 'error');}).catch(()=>setProcessing(false)); };
        const ejectSpool = (sid, loc, pickup) => { if(pickup) { fetch('/api/identify_scan', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text:"ID:"+sid})}).then(r=>r.json()).then(res=>{ if(res.type==='spool'){ if(state.heldSpools.some(s=>s.id===res.id)) showToast("In Buffer"); else { state.heldSpools.unshift({id:res.id, display:res.display, color:res.color}); renderBuffer(); } doEject(sid, loc); } }); } else { if(loc!=="Scan") requestConfirmation(`Eject spool #${sid}?`, ()=>doEject(sid, loc)); else doEject(sid, loc); } };
        const doEject = (sid, loc) => { setProcessing(true); fetch('/api/manage_contents', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'remove', location:loc, spool_id:sid})}).then(r=>r.json()).then(()=>{ setProcessing(false); showToast("Ejected"); if(loc!=="Scan") refreshManageView(loc); }).catch(()=>setProcessing(false)); };
        const manualAddSpool = () => doAssign(document.getElementById('manage-loc-id').value, document.getElementById('manual-spool-id').value, null);
        const triggerEjectAll = (loc) => promptSafety(`Nuke all unslotted in ${loc}?`, () => { setProcessing(true); fetch('/api/manage_contents', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'clear_location', location:loc})}).then(r=>r.json()).then(()=>{setProcessing(false); refreshManageView(loc); showToast("Cleared!");}); });
        
        const openEdit = (id) => { const i=state.allLocations.find(l=>l.LocationID==id); if(i){ modals.locMgrModal.hide(); document.getElementById('edit-original-id').value=id; document.getElementById('edit-id').value=id; document.getElementById('edit-name').value=i.Name; document.getElementById('edit-type').value=i.Type; document.getElementById('edit-max').value=i['Max Spools']; modals.locModal.show(); }};
        const closeEdit = () => { modals.locModal.hide(); modals.locMgrModal.show(); };
        const saveLocation = () => { fetch('/api/locations', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({old_id:document.getElementById('edit-original-id').value, new_data:{LocationID:document.getElementById('edit-id').value, Name:document.getElementById('edit-name').value, Type:document.getElementById('edit-type').value, "Max Spools":document.getElementById('edit-max').value}})}).then(()=>{modals.locModal.hide(); modals.locMgrModal.show(); fetchLocations();}); };
        const openAddModal = () => { modals.locMgrModal.hide(); document.getElementById('edit-original-id').value=""; document.getElementById('edit-id').value=""; document.getElementById('edit-name').value=""; document.getElementById('edit-max').value="1"; modals.locModal.show(); };
        const deleteLoc = (id) => requestConfirmation(`Delete ${id}?`, () => fetch(`/api/locations?id=${id}`, {method:'DELETE'}).then(fetchLocations));
        const triggerUndo = () => fetch('/api/undo', {method:'POST'}).then(fetchLogs);
        
        setInterval(() => { if(!state.logsPaused) fetch('/api/logs').then(r=>r.json()).then(d=>{ document.getElementById('live-logs').innerHTML = d.logs.map(l=>`<div class="log-${l.type}">[${l.time}] ${l.msg}</div>`).join(''); document.getElementById('undo-btn').disabled=!d.undo_available; document.getElementById('st-spoolman').className=`status-dot ${d.status.spoolman?'status-on':'status-off'}`; document.getElementById('st-filabridge').className=`status-dot ${d.status.filabridge?'status-on':'status-off'}`; }); }, 2500);
    </script>
</body>
</html>