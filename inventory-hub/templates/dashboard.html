<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Command Center {{ version }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* GLOBAL SETTINGS */
        body { background-color: #000000; color: #ffffff; font-family: 'Segoe UI', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .navbar { background-color: #111; border-bottom: 2px solid #00d4ff; flex-shrink: 0; }
        .navbar-brand { color: #00d4ff !important; font-weight: bold; font-size: 1.5rem; }
        .version-tag { color: #888; font-size: 1rem; margin-left: 10px; font-weight: bold; }
        
        /* LAYOUT */
        .main-container { flex-grow: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
        .col-logs, .col-buffer { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        
        /* LOGS */
        .log-box { flex-grow: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 1.1rem; line-height: 1.4; white-space: pre-wrap; word-break: break-all; color: #eee; }
        .log-INFO { color: #00ff00; } .log-WARNING { color: #ffcc00; } .log-ERROR { color: #ff4444; }
        
        /* BUFFER ZONE */
        .buffer-header { padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; color: #00d4ff; font-size: 1.2rem; display: flex; justify-content: space-between; }
        .buffer-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        
        .buffer-item { background: #222; border: 1px solid #555; border-radius: 8px; margin-bottom: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; opacity: 0.8; }
        .buffer-item.active-item { border: 2px solid #00ff00; opacity: 1.0; box-shadow: 0 0 10px rgba(0, 255, 0, 0.2); background: #2a2a2a; }
        
        .buffer-swatch { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; flex-shrink: 0; } 
        .buffer-text { font-size: 1.6rem; color: white; font-weight: bold; margin-left: 15px; }
        .buffer-info { display: flex; align-items: center; }

        /* QR BOXES */
        .qr-box { background: white; padding: 5px; border-radius: 4px; }
        .cmd-deck { padding: 15px; border-top: 1px solid #333; background: #1a1a1a; display: flex; justify-content: space-around; }
        .cmd-btn { cursor: pointer; transition: 0.2s; border-radius: 8px; padding: 10px; text-align: center; }
        .cmd-btn:active { background-color: #333; transform: scale(0.95); }
        .qr-label { font-size: 0.9rem; color: #ccc; text-transform: uppercase; font-weight: bold; margin-top: 5px; letter-spacing: 0.5px; }
        
        /* MODALS & Z-INDEX HIERARCHY */
        .modal-content { background-color: #121212; color: #fff; border: 1px solid #555; }
        
        /* Level 1: Location List & Edit */
        #locMgrModal, #locModal { z-index: 1055; }
        
        /* Level 2: Manage Window (Must be higher than List) */
        #manageModal { z-index: 1065; }
        
        /* Level 3: Alerts/Confirmations (Must be highest) */
        #actionModal, #safetyModal, #confirmModal { z-index: 1075; } 
        
        /* SLOTS */
        .slot-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .slot-btn { background: #222; border: 2px solid #444; border-radius: 10px; height: 180px; display: flex; flex-direction: row; align-items: center; justify-content: space-between; cursor: pointer; padding: 10px; position: relative; overflow: hidden; }
        .slot-btn.full { border-color: #00d4ff; background: #1a1a1a; }
        .slot-swatch { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 5px; flex-shrink: 0; }
        .slot-num { font-size: 1.5rem; font-weight: bold; color: #888; margin-bottom: 5px; }
        .slot-content { font-size: 1.2rem; font-weight: bold; color: white; word-break: break-word; }
        
        /* UNSLOTTED ITEMS */
        .unslotted-box { border: 2px solid #ffcc00; background: #1a1a1a; padding: 10px; margin-top: 20px; border-radius: 8px; }
        .unslotted-item { background: #252525; padding: 15px; margin: 10px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #444; }
        .control-group { display: flex; align-items: center; gap: 20px; background: #111; padding: 10px 20px; border-radius: 8px; border: 1px solid #333; }
        
        /* HEADS UP & NAV */
        .headsup-strip { background: #111; border-bottom: 1px solid #333; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-deck { display: flex; justify-content: space-between; padding: 10px 20px; background: #181818; border-bottom: 1px solid #333; gap: 20px; }
        .nav-card { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 15px 20px; display: flex; align-items: center; cursor: pointer; flex: 1; justify-content: center; transition: 0.2s; }
        .nav-card:active { background: #444; transform: translateY(2px); }
        
        /* DANGER ZONE */
        .danger-zone { border: 3px solid #ff4444; background: #2d0000; padding: 20px; border-radius: 8px; margin-top: 30px; text-align: center; }
        
        /* UTILS */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-on { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .status-off { background-color: #ff4444; box-shadow: 0 0 5px #ff4444; }
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 11000; text-align: center; width: 80%; max-width: 600px; }
        .toast-msg { background: rgba(0,0,0,0.95); color: #fff; padding: 30px; margin-bottom: 20px; border: 4px solid #00d4ff; border-radius: 12px; font-size: 2rem; font-weight: bold; }
        #focus-guard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 12000; display: none; justify-content: center; align-items: center; border: 20px solid #ff4444; text-align: center; backdrop-filter: blur(5px); }
        #processing-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000; display: none; justify-content: center; align-items: center; cursor: wait; }
    </style>
</head>
<body>
    <div id="focus-guard" onclick="document.body.focus()"><div><div style="font-size:5rem;">üö´</div><div style="font-size:3rem;color:#ff4444;font-weight:bold;">SCANNER PAUSED</div><div class="text-white">Click anywhere to resume</div></div></div>
    <div id="processing-overlay"><div class="spinner-border text-info" style="width: 5rem; height: 5rem;" role="status"></div></div>
    <div id="toast-container"></div>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <div class="d-flex align-items-center"><span class="navbar-brand">Filament Command Center</span><span class="version-tag">{{ version }}</span></div>
            <div class="d-flex align-items-center">
                <div style="margin-right:20px; color:#ccc;"><span id="st-spoolman" class="status-dot status-off"></span> Spoolman</div>
                <div style="margin-right:20px; color:#ccc;"><span id="st-filabridge" class="status-dot status-off"></span> FilaBridge</div>
                <button class="btn btn-outline-info btn-sm me-3" onclick="openLocationsModal()">üìÇ Locations</button>
                <button onclick="triggerUndo()" class="btn btn-warning btn-sm me-3" id="undo-btn" disabled>‚Ü©Ô∏è UNDO</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="col-logs">
            <div class="p-3 border-bottom border-secondary text-info fw-bold d-flex justify-content-between">
                <span>Live Activity üì°</span>
                <span id="log-status" class="small text-muted">Auto-Refresh ON</span>
            </div>
            <div id="live-logs" class="log-box" onmouseenter="pauseLogs(true)" onmouseleave="pauseLogs(false)"></div>
        </div>
        <div class="col-buffer">
            <div class="buffer-header"><span>BUFFER ZONE</span><span id="scan-status" style="font-size:1rem; color:#888;">Ready...</span></div>
            <div id="buffer-zone" class="buffer-content"></div>
            <div class="cmd-deck">
                <div class="text-center cmd-btn" onclick="processScan('CMD:CLEAR')"><div class="qr-box" id="qr-clear"></div><div class="qr-label">CLEAR</div></div>
                <div class="text-center cmd-btn" onclick="triggerUndo()"><div class="qr-box" id="qr-undo"></div><div class="qr-label">UNDO</div></div>
                <div class="text-center cmd-btn" onclick="processScan('CMD:EJECT')"><div class="qr-box" id="qr-eject"></div><div class="qr-label">EJECT MODE</div></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locMgrModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Location Manager</h5><div class="ms-auto text-muted" id="loc-count">0 Locs</div><button class="btn btn-success btn-lg ms-3" onclick="openAddModal()">+ New Slot</button><button type="button" class="btn-close btn-close-white ms-3" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><table class="table table-hover table-dark mb-0" style="font-size:1.1rem;"><thead><tr><th>ID</th><th>Name</th><th>Status</th><th class="text-end">Actions</th></tr></thead><tbody id="location-table"></tbody></table></div></div></div></div>
    
    <div class="modal fade" id="manageModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header p-2 bg-dark border-bottom border-secondary"><h5 class="modal-title ms-3" id="manageTitle">Manage</h5><button type="button" class="btn-close btn-close-white me-2" onclick="closeManage()"></button></div>
        
        <div id="headsup-buffer" class="headsup-strip" style="display:none;">
            <div class="d-flex align-items-center">
                <span class="me-3 text-warning fw-bold fs-4">‚úã READY:</span>
                <div id="headsup-swatch" class="buffer-swatch me-3"></div>
                <span id="headsup-text" class="text-white fw-bold fs-3"></span>
            </div>
            <div class="fs-4 fw-bold text-info border border-info px-3 py-1 rounded" id="headsup-total">
                Buffer: 0
            </div>
        </div>

        <div id="buffer-nav-deck" class="nav-deck" style="display:none;">
            <div class="nav-card" onclick="prevBuffer()">
                <div id="qr-prev" class="bg-white p-1 rounded me-3" style="width:50px;height:50px;"></div>
                <div class="text-start"><div class="fw-bold fs-4">< PREV</div></div>
            </div>
            <div class="nav-card" onclick="nextBuffer()">
                <div class="text-end me-3"><div class="fw-bold fs-4">NEXT ></div></div>
                <div id="qr-next" class="bg-white p-1 rounded" style="width:50px;height:50px;"></div>
            </div>
        </div>

        <div class="modal-body">
        <div id="manage-grid-view" style="display:none;">
            <div class="alert alert-info py-1 mb-2 small text-center">Tap button or scan slot QR (CMD:SLOT:X)</div>
            <div id="slot-grid-container" class="slot-grid"></div>
            <div id="unslotted-container" style="display:none;"></div>
        </div>
        <div id="manage-list-view">
            <div id="manage-contents-list" class="mb-4"></div>
        </div>
        <hr class="border-secondary"><div class="input-group mb-3"><input type="text" id="manual-spool-id" class="form-control form-control-lg" placeholder="Enter Spool ID / Scan Legacy"><button class="btn btn-primary btn-lg" onclick="manualAddSpool()">‚ûï Add</button></div>
        
        <div class="d-flex justify-content-between align-items-center bg-dark p-2 rounded border border-secondary">
            <button class="btn btn-success btn-lg flex-grow-1 me-3" onclick="closeManage()">‚úÖ Done / Sync</button>
            <div class="text-center"><div id="qr-done" class="bg-white p-1 rounded" style="cursor:pointer;" onclick="closeManage()"></div><div class="qr-label">DONE</div></div>
        </div>
        
        <input type="hidden" id="manage-loc-id"></div></div></div></div>
    
    <div class="modal fade" id="actionModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="border: 2px solid #00d4ff;"><div class="modal-header bg-dark"><h5 class="modal-title fw-bold" id="action-title">Action Needed</h5></div><div class="modal-body text-center"><p id="action-msg" class="fs-3 mb-4"></p><div id="action-buttons" class="modal-action-row"></div></div><div class="modal-footer justify-content-center"><div class="text-center"><div id="qr-modal-cancel" class="bg-white p-1 rounded mb-1 d-inline-block"></div><br><button class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelAction()">‚ùå Cancel</button></div></div></div></div></div>
    
    <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="border: 4px solid #ffcc00;"><div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold">‚ö†Ô∏è CONFIRMATION</h5></div><div class="modal-body text-center"><p id="confirm-msg" class="fs-2 fw-bold mb-4"></p><div class="d-flex justify-content-center gap-5 mt-4">
        <div class="modal-action-card" onclick="confirmAction(false)" style="border-color:#ff4444;">
            <div id="qr-confirm-no" class="modal-action-qr"></div><button class="btn btn-secondary modal-action-btn">‚ùå NO</button>
        </div>
        <div style="width: 150px;"></div>
        <div class="modal-action-card" onclick="confirmAction(true)" style="border-color:#00ff00;">
            <div id="qr-confirm-yes" class="modal-action-qr"></div><button class="btn btn-success modal-action-btn">‚úÖ YES</button>
        </div>
    </div></div></div></div></div>

    <div class="modal fade" id="safetyModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-centered"><div class="modal-content" style="border: 4px solid #ff4444;"><div class="modal-header bg-danger text-white"><h5 class="modal-title fw-bold">‚ö†Ô∏è SAFETY CONFIRMATION</h5></div><div class="modal-body text-center"><p id="safety-msg" class="fs-2 fw-bold mb-4"></p><div class="d-flex justify-content-center gap-5 mt-4">
        <div class="modal-action-card" onclick="confirmSafety(false)" style="border-color:#ff4444;">
            <div id="qr-safety-no" class="modal-action-qr"></div><button class="btn btn-secondary modal-action-btn">‚ùå NO</button>
        </div>
        <div style="width: 150px;"></div>
        <div class="modal-action-card" onclick="confirmSafety(true)" style="border-color:#00ff00;">
            <div id="qr-safety-yes" class="modal-action-qr"></div><button class="btn btn-danger modal-action-btn">‚úÖ YES</button>
        </div>
    </div></div></div></div></div>
    
    <div class="modal fade" id="locModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle">Edit Location</h5><button type="button" class="btn-close btn-close-white" onclick="closeEdit()"></button></div><div class="modal-body"><input type="hidden" id="edit-original-id"><div class="mb-3"><label>Location ID</label><input type="text" class="form-control" id="edit-id"></div><div class="mb-3"><label>Friendly Name</label><input type="text" class="form-control" id="edit-name"></div><div class="row"><div class="col-8 mb-3"><label>Type</label><select class="form-select" id="edit-type"><option value="Dryer Box">Dryer Box</option><option value="Cart">Cart</option><option value="Shelf">Shelf</option><option value="Printer">Printer</option><option value="MMU Slot">MMU Slot</option></select></div><div class="col-4 mb-3"><label>Max Spools</label><input type="number" class="form-control" id="edit-max"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeEdit()">Cancel</button><button type="button" class="btn btn-primary" onclick="saveLocation()">Save</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const DASHBOARD_VERSION = "v147.0";
        console.log("üöÄ Filament Command Center Dashboard Loaded: " + DASHBOARD_VERSION);

        // Global Declarations (Bulletproof Init)
        let locMgrModal, locModal, manageModal, confirmModal, actionModal, safetyModal;
        let scanBuffer = [];
        let bufferTimeout;
        let heldSpools = []; 
        let ejectMode = false;
        let lastScannedLoc = null;
        let pendingConfirmCallback = null;
        let safetyCallback = null;
        let allLocations = []; 
        let logsPaused = false;
        let currentGridState = {};
        let isProcessing = false;
        let modalCallbacks = []; 

        window.onload = function() {
            try {
                // INIT MODALS SAFELY
                locMgrModal = new bootstrap.Modal(document.getElementById('locMgrModal'));
                locModal = new bootstrap.Modal(document.getElementById('locModal'));
                manageModal = new bootstrap.Modal(document.getElementById('manageModal'));
                confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
                safetyModal = new bootstrap.Modal(document.getElementById('safetyModal'));

                // INIT QRS
                new QRCode(document.getElementById("qr-undo"), {text: "CMD:UNDO", width: 90, height: 90});
                new QRCode(document.getElementById("qr-clear"), {text: "CMD:CLEAR", width: 90, height: 90});
                new QRCode(document.getElementById("qr-eject"), {text: "CMD:EJECT", width: 90, height: 90});
                new QRCode(document.getElementById("qr-safety-yes"), {text: "CMD:CONFIRM", width: 120, height: 120});
                new QRCode(document.getElementById("qr-safety-no"), {text: "CMD:CANCEL", width: 120, height: 120});
                new QRCode(document.getElementById("qr-confirm-yes"), {text: "CMD:CONFIRM", width: 120, height: 120});
                new QRCode(document.getElementById("qr-confirm-no"), {text: "CMD:CANCEL", width: 120, height: 120});
                new QRCode(document.getElementById("qr-modal-cancel"), {text: "CMD:MODAL:CANCEL", width: 80, height: 80});
                new QRCode(document.getElementById("qr-done"), {text: "CMD:DONE", width: 45, height: 45});
                new QRCode(document.getElementById("qr-prev"), {text: "CMD:PREV", width: 45, height: 45});
                new QRCode(document.getElementById("qr-next"), {text: "CMD:NEXT", width: 45, height: 45});

                document.getElementById("manual-spool-id").addEventListener("keydown", function(event) { 
                    if (event.key === "Enter") { 
                        event.preventDefault(); 
                        manualAddSpool(); 
                    }
                });
            } catch (e) {
                console.error("Init Error: ", e);
            }
        };
        
        window.addEventListener('blur', () => { document.getElementById('focus-guard').style.display = 'flex'; });
        window.addEventListener('focus', () => { document.getElementById('focus-guard').style.display = 'none'; });

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('focus-guard').style.display === 'flex') return;
            if (isProcessing) return; 
            if (e.target.tagName === 'INPUT') return; 
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (scanBuffer.length > 0) processScan(scanBuffer); 
                scanBuffer = ""; 
            } 
            else if (e.key.length === 1) { 
                scanBuffer += e.key; 
                clearTimeout(bufferTimeout); 
                bufferTimeout = setTimeout(() => { scanBuffer = ""; }, 2000); 
            }
        });

        function setProcessing(state) {
            isProcessing = state;
            document.getElementById('processing-overlay').style.display = state ? 'flex' : 'none';
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div'); el.className = `toast-msg`;
            el.style.borderColor = type === 'error' ? '#ff4444' : (type === 'warning' ? '#ffcc00' : '#00d4ff');
            el.innerText = msg; container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 2000);
        }

        function pauseLogs(isPaused) {
            logsPaused = isPaused;
            const status = document.getElementById('log-status');
            if (isPaused) { status.innerText = "Paused (Selection Mode)"; status.className = "small text-warning fw-bold"; }
            else { status.innerText = "Auto-Refresh ON"; status.className = "small text-muted"; }
        }

        function nextBuffer() {
            if (heldSpools.length < 2) return;
            heldSpools.push(heldSpools.shift()); 
            renderBuffer();
        }
        
        function prevBuffer() {
            if (heldSpools.length < 2) return;
            heldSpools.unshift(heldSpools.pop());
            renderBuffer();
        }

        function renderBuffer() {
            const zone = document.getElementById('buffer-zone');
            const headsUp = document.getElementById('headsup-buffer');
            const navDeck = document.getElementById('buffer-nav-deck');
            
            if (heldSpools.length > 0) {
                zone.innerHTML = heldSpools.map((s, idx) => `
                    <div class="buffer-item ${idx === 0 ? 'active-item' : ''}">
                        <div class="buffer-info"><div class="buffer-swatch" style="background-color:#${s.color}"></div><div class="buffer-text">${s.display}</div></div>
                        <div id="qr-buf-${idx}" class="qr-box"></div>
                    </div>`).join('');
                heldSpools.forEach((s, idx) => { new QRCode(document.getElementById(`qr-buf-${idx}`), {text: "ID:" + s.id.toString(), width: 120, height: 120}); });
                
                headsUp.style.display = 'flex';
                document.getElementById('headsup-swatch').style.backgroundColor = `#${heldSpools[0].color}`;
                document.getElementById('headsup-text').innerText = heldSpools[0].display;
                document.getElementById('headsup-total').innerText = `Buffer: ${heldSpools.length}`;

                if (heldSpools.length > 1) navDeck.style.display = 'flex';
                else navDeck.style.display = 'none';
            } else { 
                zone.innerHTML = `<div class="text-center text-muted mt-5"><h3>Buffer Empty</h3><p>Scan a Spool or Location</p></div>`; 
                headsUp.style.display = 'none';
                navDeck.style.display = 'none';
            }
        }

        function processScan(text) {
            const upper = text.toUpperCase();

            // Safety Modal Interceptor
            if(document.getElementById('safetyModal').classList.contains('show')) {
                if (upper === 'CMD:CONFIRM') confirmSafety(true);
                else if (upper === 'CMD:CANCEL') confirmSafety(false);
                return;
            }
            // Confirm Modal Interceptor
            if(document.getElementById('confirmModal').classList.contains('show')) {
                if (upper === 'CMD:CONFIRM') confirmAction(true);
                else if (upper === 'CMD:CANCEL') confirmAction(false);
                return;
            }

            if(document.getElementById('actionModal').classList.contains('show')) {
                if (upper === 'CMD:MODAL:CANCEL') { actionModal.hide(); return; }
                if (upper.startsWith('CMD:MODAL:')) {
                    const idx = parseInt(upper.split(':')[2]);
                    if (modalCallbacks[idx]) { actionModal.hide(); modalCallbacks[idx](); }
                }
                return; 
            }
            
            // TRASH SCAN
            if (upper.startsWith("CMD:TRASH:")) {
                const parts = upper.split(':');
                if (parts.length === 3) {
                    const trashId = parts[2];
                    const locId = document.getElementById('manage-loc-id').value;
                    if (locId && document.getElementById('manageModal').classList.contains('show')) {
                        ejectSpool(trashId, locId, false); 
                    }
                }
                return;
            }

            setProcessing(true);
            fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: text}) })
            .then(r => r.json()).then(res => {
                setProcessing(false);
                
                if(res.type === 'command') {
                    if(res.cmd === 'confirm') { if(pendingConfirmCallback) confirmAction(true); return; }
                    if(res.cmd === 'slot') { handleSlotInteraction(res.value); return; }
                    if(res.cmd === 'clear') { heldSpools = []; renderBuffer(); showToast("Buffer Cleared", "info"); return; }
                    if(res.cmd === 'undo') { triggerUndo(); return; }
                    if(res.cmd === 'eject') { showToast("EJECT MODE: Scan a Spool", "warning"); ejectMode = true; return; }
                    
                    if(res.cmd === 'next') { nextBuffer(); return; }
                    if(res.cmd === 'prev') { prevBuffer(); return; }
                    
                    if(res.cmd === 'done') { closeManage(); return; }
                    if(res.cmd === 'ejectall') { 
                        const locId = document.getElementById('manage-loc-id').value;
                        if(document.getElementById('manageModal').classList.contains('show') && locId) {
                             triggerEjectAll(locId);
                        }
                        return; 
                    }
                }

                if(res.type === 'location') { lastScannedLoc = res.id; if(document.getElementById('locMgrModal').classList.contains('show')) scrollToRow(res.id); }
                if (ejectMode && res.type === 'spool') { ejectSpool(res.id, "Scan", false); ejectMode = false; return; }
                
                if (res.type === 'spool') {
                    if (heldSpools.some(s => s.id === res.id)) showToast("‚ö†Ô∏è ALREADY IN BUFFER", "warning");
                    else { 
                        heldSpools.unshift({id: res.id, display: res.display, color: res.color}); 
                        renderBuffer(); 
                    }
                } else if (res.type === 'location') {
                    if (heldSpools.length > 0) {
                        performContextAssign(res.id);
                    } else {
                        openManage(res.id);
                    }
                } else if (res.type === 'error') {
                     showToast(res.msg, "error");
                }
            }).catch(() => setProcessing(false));
        }

        function performContextAssign(targetLoc) {
            if(heldSpools.length === 0) return;
            const spool = heldSpools[0]; 
            
            setProcessing(true);
            fetch('/api/smart_move', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({location: targetLoc, spools: [spool.id]})
            }).then(r => r.json()).then(res => {
                setProcessing(false);
                if (res.status === 'success') {
                    showToast(`Assigned ${spool.display} to ${targetLoc}`, "success");
                    heldSpools.shift(); 
                    renderBuffer();
                    
                    const currentLoc = document.getElementById('manage-loc-id').value;
                    if (currentLoc === targetLoc && document.getElementById('manageModal').classList.contains('show')) {
                        refreshManageView(targetLoc);
                    }
                } else {
                    showToast(res.msg, "error");
                }
            }).catch(() => setProcessing(false));
        }

        function promptSafety(msg, callback) {
            document.getElementById('safety-msg').innerText = msg;
            safetyCallback = callback;
            safetyModal.show();
        }
        function confirmSafety(isYes) {
            safetyModal.hide();
            if(isYes && safetyCallback) safetyCallback();
            safetyCallback = null;
        }

        function requestConfirmation(msg, callback) { 
            document.getElementById('confirm-msg').innerText = msg; 
            pendingConfirmCallback = callback; 
            confirmModal.show(); 
        }
        function confirmAction(isYes) { 
            confirmModal.hide(); 
            if(isYes && pendingConfirmCallback) pendingConfirmCallback(); 
            pendingConfirmCallback = null; 
        }

        function promptAction(title, msg, buttons) {
            document.getElementById('action-title').innerText = title;
            document.getElementById('action-msg').innerHTML = msg;
            const btnContainer = document.getElementById('action-buttons');
            btnContainer.innerHTML = "";
            modalCallbacks = []; 

            buttons.forEach((btn, idx) => {
                modalCallbacks.push(btn.action); 
                const card = document.createElement('div');
                card.className = "modal-action-card";
                card.onclick = () => { actionModal.hide(); btn.action(); };
                
                const qrDiv = document.createElement('div');
                qrDiv.className = "modal-action-qr";
                qrDiv.id = `qr-mod-${idx}`;
                
                const b = document.createElement('button');
                b.className = `btn btn-${btn.cls || 'primary'} modal-action-btn`;
                b.innerHTML = btn.label;
                
                card.appendChild(qrDiv);
                card.appendChild(b);
                btnContainer.appendChild(card);
                new QRCode(qrDiv, {text: `CMD:MODAL:${idx}`, width: 120, height: 120});
            });
            actionModal.show();
        }
        function cancelAction() { actionModal.hide(); }

        function triggerEjectAll(locId) {
             promptSafety(`Eject ALL unslotted items from ${locId}?`, () => { doEjectAll(locId); });
        }

        function handleSlotInteraction(slotNum) {
            if (!document.getElementById('manageModal').classList.contains('show')) return;
            const locId = document.getElementById('manage-loc-id').value;
            const itemInSlot = currentGridState[slotNum.toString()];

            if (heldSpools.length > 0) {
                const newItem = heldSpools[0];
                if (itemInSlot) {
                    promptAction("‚ö†Ô∏è Slot Occupied", `Slot ${slotNum} holds <b>${itemInSlot.display}</b>.<br>Assigning <b>${newItem.display}</b>.`, [
                        { label: "üîÑ Swap", cls: "info", action: () => {
                            heldSpools.shift(); 
                            heldSpools.push({id: itemInSlot.id, display: itemInSlot.display, color: itemInSlot.color}); 
                            renderBuffer();
                            doAssign(locId, newItem.id, slotNum);
                        }},
                        { label: "‚¨áÔ∏è Overwrite", cls: "warning", action: () => {
                            heldSpools.shift();
                            renderBuffer();
                            doAssign(locId, newItem.id, slotNum);
                        }}
                    ]);
                } else {
                    heldSpools.shift();
                    renderBuffer();
                    doAssign(locId, newItem.id, slotNum);
                }
            } 
            else {
                if (itemInSlot) {
                     promptAction("Slot Action", `Slot ${slotNum}: <b>${itemInSlot.display}</b>`, [
                        { label: "‚úã Pick Up", cls: "success", action: () => {
                            heldSpools.unshift({id: itemInSlot.id, display: itemInSlot.display, color: itemInSlot.color}); // ACTIVE FIRST
                            renderBuffer();
                            doEject(itemInSlot.id, locId, false);
                        }},
                        { label: "‚èèÔ∏è Eject", cls: "danger", action: () => {
                            doEject(itemInSlot.id, locId, false);
                        }}
                    ]);
                } else {
                    showToast("Slot Empty & Buffer Empty", "warning");
                }
            }
        }

        function doAssign(locId, spoolId, slotNum) {
            setProcessing(true);
            fetch('/api/manage_contents', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({action: 'add', location: locId, spool_id: "ID:" + spoolId, slot: slotNum}) 
            }).then(r => r.json()).then(res => {
                setProcessing(false);
                if (res.status === 'success') {
                    showToast(`Assigned to Slot ${slotNum}`, "info");
                    refreshManageView(locId);
                } else showToast(res.msg, "error");
            }).catch(() => setProcessing(false));
        }

        function openManage(locId) {
            console.log("Open Manage for:", locId); // DEBUG LOG
            document.getElementById('manage-grid-view').style.display = 'none';
            document.getElementById('manage-list-view').style.display = 'none';
            document.getElementById('manageTitle').innerText = `Manage: ${locId}`;
            document.getElementById('manage-loc-id').value = locId;
            document.getElementById('manual-spool-id').value = "";
            const success = refreshManageView(locId);
            if(success) manageModal.show();
            else showToast(`Error: Location '${locId}' data not found.`, 'error');
        }

        function closeManage() {
            manageModal.hide();
            fetchLocations();
        }

        function refreshManageView(locId) {
             const locData = allLocations.find(l => String(l.LocationID) == String(locId));
             if(!locData) return false;
             fetchLogs();
             const isGrid = (locData.Type === 'Dryer Box' || locData.Type === 'MMU Slot') && parseInt(locData['Max Spools']) > 1;
             
             if (isGrid) {
                 document.getElementById('manage-grid-view').style.display = 'block';
                 document.getElementById('manage-list-view').style.display = 'none';
                 renderSlotGrid(locId, parseInt(locData['Max Spools']));
             } else {
                 document.getElementById('manage-grid-view').style.display = 'none';
                 document.getElementById('manage-list-view').style.display = 'block';
                 refreshManageList(locId);
             }
             renderBuffer();
             return true;
        }

        function renderSlotGrid(locId, maxSlots) {
            const grid = document.getElementById('slot-grid-container');
            const unslottedBox = document.getElementById('unslotted-container');
            
            fetch(`/api/get_contents?id=${locId}`).then(r => r.json()).then(data => {
                grid.innerHTML = "";
                unslottedBox.innerHTML = "";
                const slotMap = {};
                const unslotted = [];

                data.forEach(item => { 
                    if(item.slot && parseInt(item.slot) > 0) slotMap[item.slot.toString()] = item; 
                    else unslotted.push(item);
                });
                currentGridState = slotMap;

                for (let i = 1; i <= maxSlots; i++) {
                    const item = slotMap[i.toString()];
                    const div = document.createElement('div');
                    const qrId = `qr-slot-${i}`;
                    
                    if (item) {
                        div.className = "slot-btn full";
                        div.innerHTML = `<div class="slot-left"><div class="slot-num">Slot ${i}</div><div id="${qrId}" class="slot-qr"></div></div><div class="slot-right"><div class="slot-swatch" style="background-color:#${item.color}"></div><div class="slot-content">${item.display}</div></div>`;
                        div.onclick = () => handleSlotInteraction(i); 
                    } else {
                        div.className = "slot-btn empty";
                        div.innerHTML = `<div class="slot-left"><div class="slot-num">Slot ${i}</div><div id="${qrId}" class="slot-qr"></div></div><div class="slot-right"><div class="text-muted fs-4">EMPTY</div></div>`;
                        div.onclick = () => handleSlotInteraction(i); 
                    }
                    grid.appendChild(div);
                    new QRCode(document.getElementById(qrId), {text: "CMD:SLOT:" + i, width: 60, height: 60});
                }

                if (unslotted.length > 0) {
                    unslottedBox.style.display = 'block';
                    
                    // ITEMS
                    unslotted.forEach((item, idx) => {
                        const div = document.createElement('div');
                        div.className = "unslotted-item";
                        const qrPickId = `qr-pick-${idx}`;
                        const qrTrashId = `qr-trash-${idx}`;
                        
                        div.innerHTML = `
                            <div class="d-flex align-items-center">
                                <div class="buffer-swatch me-3" style="width:30px;height:30px;background-color:#${item.color};border:2px solid white;"></div>
                                <span class="text-white fw-bold fs-5">${item.display}</span>
                            </div>
                            <div class="control-group">
                                <div class="text-center">
                                    <div id="${qrPickId}" class="bg-white p-1 rounded d-inline-block"></div>
                                    <div class="qr-label">PICK UP</div>
                                </div>
                                <button class="btn btn-primary fw-bold" onclick="ejectSpool(${item.id}, '${locId}', true)">‚úã</button>
                                <div style="width:20px;"></div>
                                <button class="btn btn-danger fw-bold" onclick="ejectSpool(${item.id}, '${locId}', false)">üóëÔ∏è</button>
                                <div class="text-center">
                                    <div id="${qrTrashId}" class="bg-white p-1 rounded d-inline-block"></div>
                                    <div class="qr-label">TRASH</div>
                                </div>
                            </div>
                        `;
                        
                        unslottedBox.appendChild(div);
                        new QRCode(document.getElementById(qrPickId), {text: "ID:" + item.id, width: 50, height: 50});
                        new QRCode(document.getElementById(qrTrashId), {text: "CMD:TRASH:" + item.id, width: 50, height: 50});
                    });

                    // DANGER ZONE (EJECT ALL)
                    const dangerZone = document.createElement('div');
                    dangerZone.className = "danger-zone";
                    dangerZone.innerHTML = `<h4 class="text-danger fw-bold">DANGER ZONE</h4><div class="d-flex justify-content-center align-items-center gap-3"><div class="text-center"><div id="qr-eject-all" class="bg-white p-2 rounded"></div><div class="qr-label mt-1 text-white">SCAN TO EJECT ALL</div></div><button class="btn btn-danger btn-lg fw-bold" onclick="triggerEjectAll('${locId}')">EJECT ALL üí•</button></div>`;
                    
                    unslottedBox.appendChild(dangerZone);
                    new QRCode(document.getElementById("qr-eject-all"), {text: "CMD:EJECTALL", width: 100, height: 100});
                }
            });
        }

        function doEjectAll(locId) {
            setProcessing(true);
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'clear_location', location: locId}) })
            .then(r => r.json()).then((res) => { 
                setProcessing(false);
                refreshManageView(locId);
                fetchLogs(); 
                showToast("üí• All Unslotted Ejected!", "warning");
            }).catch(() => setProcessing(false));
        }

        function ejectSpool(spoolId, locId, pickup) {
            if (pickup) {
                fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: "ID:"+spoolId}) })
                .then(r=>r.json()).then(res => {
                    if(res.type === 'spool') {
                        if (heldSpools.some(s => s.id === res.id)) showToast("Already in Buffer", "warning");
                        else { 
                            heldSpools.unshift({id: res.id, display: res.display, color: res.color}); 
                            renderBuffer(); 
                        }
                        doEject(spoolId, locId);
                    }
                });
            } else {
                if(locId !== "Scan") { requestConfirmation("Eject spool #" + spoolId + "?", () => { doEject(spoolId, locId); }); } 
                else doEject(spoolId, locId);
            }
        }

        function doEject(spoolId, locId) {
            setProcessing(true);
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'remove', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then((res) => { 
                setProcessing(false);
                if(locId === "Scan") showToast("‚èèÔ∏è EJECTED", "warning");
                else { showToast("‚èèÔ∏è EJECTED", "warning"); refreshManageView(locId); }
                fetchLogs(); 
            }).catch(() => setProcessing(false));
        }

        function openLocationsModal() { locMgrModal.show(); fetchLocations(); }
        function scrollToRow(id) { setTimeout(() => { const row = document.getElementById(`row-${id}`); if(row) { row.scrollIntoView({behavior: "smooth", block: "center"}); row.classList.add('highlight-row'); } }, 500); }
        function fetchLocations() {
            fetch('/api/locations').then(r => r.json()).then(data => {
                allLocations = data; 
                document.getElementById('loc-count').innerText = data.length + " Locs";
                document.getElementById('location-table').innerHTML = data.map(l => `
                    <tr id="row-${l.LocationID}"><td style="font-weight:bold;color:#00d4ff;">${l.LocationID}</td><td>${l.Name}</td><td>${l.Occupancy || ''} <span class="badge bg-secondary ms-2">${l.Type}</span></td>
                    <td class="text-end"><button class="btn btn-sm btn-outline-warning me-1" onclick="openEdit('${l.LocationID}')">‚úèÔ∏è</button><button class="btn btn-sm btn-outline-danger me-1" onclick="deleteLoc('${l.LocationID}')">üóëÔ∏è</button><button class="btn btn-sm btn-info" data-id="${l.LocationID}" onclick="openManage(this.getAttribute('data-id'))">Manage</button></td></tr>`).join('');
                if(lastScannedLoc) scrollToRow(lastScannedLoc);
            });
        }
        function manualAddSpool() {
            const locId = document.getElementById('manage-loc-id').value;
            const spoolId = document.getElementById('manual-spool-id').value; if(!spoolId) return;
            setProcessing(true);
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'add', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then(res => { setProcessing(false); if(res.status === 'error') showToast(res.msg, "error"); else { document.getElementById('manual-spool-id').value = ""; refreshManageView(locId); fetchLogs(); } }).catch(() => setProcessing(false));
        }
        function openAddModal() { locMgrModal.hide(); document.getElementById('modalTitle').innerText = "Add New Location"; document.getElementById('edit-original-id').value = ""; document.getElementById('edit-id').value = ""; document.getElementById('edit-name').value = ""; document.getElementById('edit-max').value = "1"; locModal.show(); }
        function openEdit(locId) { const item = allLocations.find(l => l.LocationID === locId); if(!item) return; locMgrModal.hide(); document.getElementById('modalTitle').innerText = "Edit Location"; document.getElementById('edit-original-id').value = locId; document.getElementById('edit-id').value = locId; document.getElementById('edit-name').value = item.Name || ""; document.getElementById('edit-type').value = item.Type || "Dryer Box"; document.getElementById('edit-max').value = item['Max Spools'] || "1"; locModal.show(); }
        function closeEdit() { locModal.hide(); locMgrModal.show(); }
        function saveLocation() { const payload = { old_id: document.getElementById('edit-original-id').value, new_data: { LocationID: document.getElementById('edit-id').value, Name: document.getElementById('edit-name').value, Type: document.getElementById('edit-type').value, "Max Spools": document.getElementById('edit-max').value, "Label Printed": "No" }}; fetch('/api/locations', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }).then(() => { lastScannedLoc = payload.new_data.LocationID; locModal.hide(); locMgrModal.show(); setTimeout(fetchLocations, 200); }); }
        function deleteLoc(id) { requestConfirmation("Delete Location " + id + " AND unassign all spools?", () => { fetch('/api/locations?id=' + id, { method: 'DELETE' }).then(() => { lastScannedLoc = null; fetchLocations(); }); }); }
        function triggerUndo() { fetch('/api/undo', { method: 'POST' }).then(() => fetchLogs()); }
        function fetchLogs() { if(logsPaused) return; fetch('/api/logs').then(r => r.json()).then(data => { document.getElementById('live-logs').innerHTML = data.logs.map(l => `<div class="log-${l.type}">[${l.time}] ${l.msg}</div>`).join(''); document.getElementById('undo-btn').disabled = !data.undo_available; document.getElementById('st-spoolman').className = `status-dot ${data.status.spoolman ? 'status-on' : 'status-off'}`; document.getElementById('st-filabridge').className = `status-dot ${data.status.filabridge ? 'status-on' : 'status-off'}`; }); }
        setInterval(fetchLogs, 2500);
    </script>
</body>
</html>