<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Command Center {{ version }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #0e0e0e; color: #f0f0f0; font-family: 'Segoe UI', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .navbar { background-color: #1a1a1a; border-bottom: 2px solid #00d4ff; flex-shrink: 0; }
        .navbar-brand { color: #00d4ff !important; font-weight: bold; font-size: 1.5rem; }
        .version-tag { color: #888; font-size: 1rem; margin-left: 10px; font-weight: bold; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-on { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .status-off { background-color: #ff4444; box-shadow: 0 0 5px #ff4444; }
        .main-container { flex-grow: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
        .col-logs { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        .log-box { flex-grow: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 1.2rem; line-height: 1.6; }
        .log-INFO { color: #00ff00; } .log-WARNING { color: #ffcc00; } .log-ERROR { color: #ff4444; }
        .col-buffer { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        .buffer-header { padding: 15px; background: #222; border-bottom: 1px solid #333; font-weight: bold; color: #00d4ff; font-size: 1.2rem; display: flex; justify-content: space-between; }
        .buffer-content { flex-grow: 1; overflow-y: auto; padding: 15px; }
        .buffer-item { background: #2a2a2a; border: 1px solid #444; border-radius: 8px; margin-bottom: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; opacity: 0.6; }
        .buffer-item.active-item { border: 2px solid #00ff00; opacity: 1.0; box-shadow: 0 0 10px rgba(0, 255, 0, 0.2); }
        .buffer-swatch { width: 50px; height: 50px; border-radius: 50%; border: 3px solid #fff; }
        .buffer-text { font-size: 1.6rem; color: white; font-weight: bold; }
        .qr-box { background: white; padding: 5px; border-radius: 4px; }
        .cmd-deck { padding: 15px; border-top: 1px solid #333; background: #222; display: flex; justify-content: space-around; }
        .modal-content { background-color: #121212; color: #fff; border: 1px solid #555; }
        .table-dark { --bs-table-bg: #181818; }
        .highlight-row { border: 4px solid #ffff00 !important; background-color: #333 !important; }
        .eject-btn { padding: 15px 30px; font-size: 1.5rem; border-radius: 8px; height: 100%; display: flex; align-items: center; }
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 11000; text-align: center; width: 80%; max-width: 600px; }
        .toast-msg { background: rgba(0,0,0,0.95); color: #fff; padding: 30px; margin-bottom: 20px; border: 4px solid #00d4ff; border-radius: 12px; font-size: 2rem; font-weight: bold; }
        #focus-guard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: none; justify-content: center; align-items: center; border: 20px solid #ff4444; text-align: center; backdrop-filter: blur(5px); }
        #processing-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 12000; display: none; justify-content: center; align-items: center; cursor: wait; }
        .slot-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .slot-btn { background: #222; border: 2px solid #444; border-radius: 10px; height: 180px; display: flex; flex-direction: row; align-items: center; justify-content: space-between; cursor: pointer; padding: 10px; position: relative; overflow: hidden; }
        .slot-btn:active { background: #444; border-color: #fff; }
        .slot-btn.full { border-color: #00d4ff; background: #1a1a1a; }
        .slot-btn.empty { border-color: #666; border-style: dashed; }
        .slot-left { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 40%; }
        .slot-right { display: flex; flex-direction: column; justify-content: center; align-items: center; width: 60%; text-align: center; }
        .slot-num { font-size: 1.5rem; font-weight: bold; color: #888; margin-bottom: 5px; }
        .slot-content { font-size: 1.1rem; font-weight: bold; color: white; word-break: break-word; }
        .slot-swatch { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #fff; margin-bottom: 5px; }
        .slot-qr { background: white; padding: 4px; border-radius: 4px; }
        .unslotted-box { border: 2px solid #ffcc00; background: #222; padding: 10px; margin-top: 20px; border-radius: 8px; }
        .unslotted-item { background: #333; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #555; }
        .unslotted-item:hover { background: #444; border-color: #fff; }
    </style>
</head>
<body>
    <div id="focus-guard" onclick="document.body.focus()"><div><div style="font-size:5rem;">üö´</div><div style="font-size:3rem;color:#ff4444;font-weight:bold;">SCANNER PAUSED</div><div class="text-white">Click anywhere to resume</div></div></div>
    <div id="processing-overlay"><div class="spinner-border text-info" style="width: 5rem; height: 5rem;" role="status"></div></div>
    <div id="toast-container"></div>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <div class="d-flex align-items-center"><span class="navbar-brand">Filament Command Center</span><span class="version-tag">{{ version }}</span></div>
            <div class="d-flex align-items-center">
                <div style="margin-right:20px; color:#ccc;"><span id="st-spoolman" class="status-dot status-off"></span> Spoolman</div>
                <div style="margin-right:20px; color:#ccc;"><span id="st-filabridge" class="status-dot status-off"></span> FilaBridge</div>
                <button class="btn btn-outline-info btn-sm me-3" onclick="openLocationsModal()">üìÇ Locations</button>
                <button onclick="triggerUndo()" class="btn btn-warning btn-sm me-3" id="undo-btn" disabled>‚Ü©Ô∏è UNDO</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="col-logs">
            <div class="p-3 border-bottom border-secondary text-info fw-bold d-flex justify-content-between">
                <span>Live Activity üì°</span>
                <span id="log-status" class="small text-muted">Auto-Refresh ON</span>
            </div>
            <div id="live-logs" class="log-box" onmouseenter="pauseLogs(true)" onmouseleave="pauseLogs(false)"></div>
        </div>
        <div class="col-buffer">
            <div class="buffer-header"><span>BUFFER ZONE</span><span id="scan-status" style="font-size:1rem; color:#888;">Ready...</span></div>
            <div id="buffer-zone" class="buffer-content"></div>
            <div class="cmd-deck">
                <div class="text-center"><div class="qr-box" id="qr-clear"></div>CLEAR</div>
                <div class="text-center"><div class="qr-box" id="qr-undo"></div>UNDO</div>
                <div class="text-center"><div class="qr-box" id="qr-eject"></div>EJECT</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locMgrModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Location Manager</h5><div class="ms-auto text-muted" id="loc-count">0 Locs</div><button class="btn btn-success btn-lg ms-3" onclick="openAddModal()">+ New Slot</button><button type="button" class="btn-close btn-close-white ms-3" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><table class="table table-hover table-dark mb-0" style="font-size:1.1rem;"><thead><tr><th>ID</th><th>Name</th><th>Status</th><th class="text-end">Actions</th></tr></thead><tbody id="location-table"></tbody></table></div></div></div></div>
    
    <div class="modal fade" id="manageModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="manageTitle">Manage</h5><button type="button" class="btn-close btn-close-white" onclick="closeManage()"></button></div><div class="modal-body">
        <div id="manage-grid-view" style="display:none;">
            <div class="alert alert-info py-1 mb-2 small text-center">Tap button or scan slot QR (CMD:SLOT:X)</div>
            <div id="slot-grid-container" class="slot-grid"></div>
            <div id="unslotted-container" style="display:none;"></div>
        </div>
        <div id="manage-list-view">
            <div id="manage-contents-list" class="mb-4"></div>
        </div>
        <hr class="border-secondary"><div class="input-group mb-3"><input type="text" id="manual-spool-id" class="form-control form-control-lg" placeholder="Enter Spool ID / Scan Legacy"><button class="btn btn-primary btn-lg" onclick="manualAddSpool()">‚ûï Add</button></div><div class="d-grid gap-2"><button class="btn btn-success btn-lg" onclick="closeManage()">‚úÖ Done / Sync Buffer</button></div><input type="hidden" id="manage-loc-id"></div></div></div></div>
    
    <div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-centered"><div class="modal-content" style="border: 4px solid #ffcc00;"><div class="modal-header bg-warning text-dark"><h5 class="modal-title fw-bold">‚ö†Ô∏è CONFIRM ACTION</h5></div><div class="modal-body text-center"><p id="confirm-msg" style="font-size:1.5rem;">Are you sure?</p><div class="bg-white p-2 d-inline-block rounded mb-2"><div id="qr-confirm"></div><div class="small fw-bold text-dark">CMD:CONFIRM</div></div></div><div class="modal-footer justify-content-center"><button type="button" class="btn btn-secondary btn-lg" style="width:40%;" onclick="confirmAction(false)">NO</button><button type="button" class="btn btn-warning btn-lg" style="width:40%;" onclick="confirmAction(true)">YES</button></div></div></div></div>
    
    <div class="modal fade" id="locModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="modalTitle">Edit Location</h5><button type="button" class="btn-close btn-close-white" onclick="closeEdit()"></button></div><div class="modal-body"><input type="hidden" id="edit-original-id"><div class="mb-3"><label>Location ID</label><input type="text" class="form-control" id="edit-id"></div><div class="mb-3"><label>Friendly Name</label><input type="text" class="form-control" id="edit-name"></div><div class="row"><div class="col-8 mb-3"><label>Type</label><select class="form-select" id="edit-type"><option value="Dryer Box">Dryer Box</option><option value="Cart">Cart</option><option value="Shelf">Shelf</option><option value="Printer">Printer</option><option value="MMU Slot">MMU Slot</option></select></div><div class="col-4 mb-3"><label>Max Spools</label><input type="number" class="form-control" id="edit-max"></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeEdit()">Cancel</button><button type="button" class="btn btn-primary" onclick="saveLocation()">Save</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.onload = function() {
            new QRCode(document.getElementById("qr-undo"), {text: "CMD:UNDO", width: 90, height: 90});
            new QRCode(document.getElementById("qr-clear"), {text: "CMD:CLEAR", width: 90, height: 90});
            new QRCode(document.getElementById("qr-eject"), {text: "CMD:EJECT", width: 90, height: 90});
            new QRCode(document.getElementById("qr-confirm"), {text: "CMD:CONFIRM", width: 128, height: 128});
            document.getElementById("manual-spool-id").addEventListener("keydown", function(event) { if (event.key === "Enter") { event.preventDefault(); manualAddSpool(); }});
        };
        
        let scanBuffer = "";
        let bufferTimeout;
        let heldSpools = []; 
        let ejectMode = false;
        let lastScannedLoc = null;
        let pendingConfirmCallback = null;
        let allLocations = []; 
        let logsPaused = false;
        let currentGridState = {};
        let isProcessing = false; // RACE CONDITION LOCK

        window.addEventListener('blur', () => { document.getElementById('focus-guard').style.display = 'flex'; });
        window.addEventListener('focus', () => { document.getElementById('focus-guard').style.display = 'none'; });

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('focus-guard').style.display === 'flex') return;
            if (isProcessing) return; // IGNORE INPUT WHILE PROCESSING
            if (e.target.tagName === 'INPUT') return; 
            
            if (e.key === 'Enter') { 
                e.preventDefault(); 
                if (scanBuffer.length > 0) processScan(scanBuffer); 
                scanBuffer = ""; 
            } else if (e.key.length === 1) { 
                scanBuffer += e.key; 
                clearTimeout(bufferTimeout); 
                bufferTimeout = setTimeout(() => { scanBuffer = ""; }, 2000); 
            }
        });

        function setProcessing(state) {
            isProcessing = state;
            document.getElementById('processing-overlay').style.display = state ? 'flex' : 'none';
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div'); el.className = `toast-msg`;
            el.style.borderColor = type === 'error' ? '#ff4444' : (type === 'warning' ? '#ffcc00' : '#00d4ff');
            el.innerText = msg; container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 2000);
        }

        function pauseLogs(isPaused) {
            logsPaused = isPaused;
            const status = document.getElementById('log-status');
            if (isPaused) { status.innerText = "Paused (Selection Mode)"; status.className = "small text-warning fw-bold"; }
            else { status.innerText = "Auto-Refresh ON"; status.className = "small text-muted"; }
        }

        function renderBuffer() {
            const zone = document.getElementById('buffer-zone');
            if (heldSpools.length > 0) {
                zone.innerHTML = heldSpools.map((s, idx) => `
                    <div class="buffer-item ${idx === 0 ? 'active-item' : ''}">
                        <div class="buffer-info"><div class="buffer-swatch" style="background-color:#${s.color}"></div><div class="buffer-text">${s.display}</div></div>
                        <div id="qr-buf-${idx}" class="qr-box"></div>
                    </div>`).join('');
                heldSpools.forEach((s, idx) => { new QRCode(document.getElementById(`qr-buf-${idx}`), {text: "ID:" + s.id.toString(), width: 120, height: 120}); });
            } else { zone.innerHTML = `<div class="text-center text-muted mt-5"><h3>Buffer Empty</h3><p>Scan a Spool or Location</p></div>`; }
        }

        function processScan(text) {
            setProcessing(true);
            fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: text}) })
            .then(r => r.json()).then(res => {
                setProcessing(false);
                
                if(res.type === 'command') {
                    if(res.cmd === 'confirm') { if(pendingConfirmCallback) confirmAction(true); return; }
                    if(res.cmd === 'slot') { handleSlotInteraction(res.value); return; }
                    if(res.cmd === 'clear') { heldSpools = []; renderBuffer(); showToast("Buffer Cleared", "info"); return; }
                    if(res.cmd === 'undo') { triggerUndo(); return; }
                    if(res.cmd === 'eject') { showToast("EJECT MODE: Scan a Spool", "warning"); ejectMode = true; return; }
                }

                if(res.type === 'location') { lastScannedLoc = res.id; if(document.getElementById('locMgrModal').classList.contains('show')) scrollToRow(res.id); }
                if (ejectMode && res.type === 'spool') { ejectSpool(res.id, "Scan"); ejectMode = false; return; }
                
                if (res.type === 'spool') {
                    if (heldSpools.some(s => s.id === res.id)) showToast("‚ö†Ô∏è ALREADY IN BUFFER", "warning");
                    else { heldSpools.push({id: res.id, display: res.display, color: res.color}); renderBuffer(); }
                } else if (res.type === 'location') {
                    openManage(res.id);
                } else if (res.type === 'error') {
                     showToast(res.msg, "error");
                }
            }).catch(() => setProcessing(false));
        }

        function openManage(locId) {
            document.getElementById('manageTitle').innerText = `Manage: ${locId}`;
            document.getElementById('manage-loc-id').value = locId;
            document.getElementById('manual-spool-id').value = "";
            const locData = allLocations.find(l => l.LocationID === locId);
            const isGrid = locData && (locData.Type === 'Dryer Box' || locData.Type === 'MMU Slot') && parseInt(locData['Max Spools']) > 1;
            
            if (isGrid) {
                document.getElementById('manage-grid-view').style.display = 'block';
                document.getElementById('manage-list-view').style.display = 'none';
                renderSlotGrid(locId, parseInt(locData['Max Spools']));
            } else {
                document.getElementById('manage-grid-view').style.display = 'none';
                document.getElementById('manage-list-view').style.display = 'block';
                refreshManageList(locId);
            }
            manageModal.show();
        }

        function renderSlotGrid(locId, maxSlots) {
            const grid = document.getElementById('slot-grid-container');
            const unslottedBox = document.getElementById('unslotted-container');
            grid.innerHTML = "<div class='text-center text-white'>Loading Slots...</div>";
            unslottedBox.style.display = 'none';
            
            fetch(`/api/get_contents?id=${locId}`).then(r => r.json()).then(data => {
                grid.innerHTML = "";
                unslottedBox.innerHTML = "";
                const slotMap = {};
                const unslotted = [];

                data.forEach(item => { 
                    if(item.slot && parseInt(item.slot) > 0) slotMap[item.slot.toString()] = item; 
                    else unslotted.push(item);
                });
                
                currentGridState = slotMap;

                for (let i = 1; i <= maxSlots; i++) {
                    const item = slotMap[i.toString()];
                    const div = document.createElement('div');
                    const qrId = `qr-slot-${i}`;
                    
                    if (item) {
                        div.className = "slot-btn full";
                        div.innerHTML = `<div class="slot-left"><div class="slot-num">Slot ${i}</div><div id="${qrId}" class="slot-qr"></div></div><div class="slot-right"><div class="slot-swatch" style="background-color:#${item.color}"></div><div class="slot-content">${item.display}</div></div>`;
                        div.onclick = () => ejectSpool(item.id, locId); 
                    } else {
                        div.className = "slot-btn empty";
                        div.innerHTML = `<div class="slot-left"><div class="slot-num">Slot ${i}</div><div id="${qrId}" class="slot-qr"></div></div><div class="slot-right"><div class="text-muted fs-4">EMPTY</div></div>`;
                        div.onclick = () => handleSlotInteraction(i); 
                    }
                    grid.appendChild(div);
                    new QRCode(document.getElementById(qrId), {text: "CMD:SLOT:" + i, width: 60, height: 60});
                }

                if (unslotted.length > 0) {
                    unslottedBox.style.display = 'block';
                    unslottedBox.innerHTML = `<h5 class="text-warning fw-bold">‚ö†Ô∏è Unslotted Items (${unslotted.length})</h5><div class="text-muted small mb-2">Scan QR or Tap to Pick Up</div>`;
                    
                    unslotted.forEach((item, idx) => {
                        const div = document.createElement('div');
                        div.className = "unslotted-item";
                        const qrId = `qr-unslot-${idx}`;
                        div.innerHTML = `<div class="d-flex align-items-center"><div id="${qrId}" class="bg-white p-1 me-2 rounded"></div><div class="buffer-swatch me-2" style="width:25px;height:25px;background-color:#${item.color};"></div><span class="text-white fw-bold">${item.display}</span></div><div class="text-info fw-bold">PICK UP ‚úã</div>`;
                        
                        div.onclick = () => {
                            if (heldSpools.some(s => s.id === item.id)) showToast("Already in Buffer", "warning");
                            else { heldSpools.push({id: item.id, display: item.display, color: item.color}); renderBuffer(); showToast("Picked Up! Select Slot.", "info"); }
                        };
                        unslottedBox.appendChild(div);
                        new QRCode(document.getElementById(qrId), {text: "ID:" + item.id, width: 64, height: 64});
                    });
                }
            });
        }

        function handleSlotInteraction(slotNum) {
            if (!document.getElementById('manageModal').classList.contains('show')) return;
            const locId = document.getElementById('manage-loc-id').value;

            if (heldSpools.length > 0) {
                const spool = heldSpools[0];
                setProcessing(true);
                fetch('/api/manage_contents', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({action: 'add', location: locId, spool_id: "ID:" + spool.id, slot: slotNum}) 
                }).then(r => r.json()).then(res => {
                    setProcessing(false);
                    if (res.status === 'success') {
                        heldSpools.shift(); 
                        renderBuffer();
                        showToast(`Assigned to Slot ${slotNum}`, "info");
                        const locData = allLocations.find(l => l.LocationID === locId);
                        renderSlotGrid(locId, parseInt(locData['Max Spools']));
                        fetchLogs();
                    } else {
                        showToast(res.msg, "error");
                    }
                }).catch(() => setProcessing(false));
            } else {
                const itemInSlot = currentGridState[slotNum.toString()];
                if (itemInSlot) {
                    doEject(itemInSlot.id, locId);
                } else {
                    showToast("Slot Empty & Buffer Empty", "warning");
                }
            }
        }

        const locMgrModal = new bootstrap.Modal(document.getElementById('locMgrModal'));
        const locModal = new bootstrap.Modal(document.getElementById('locModal'));
        const manageModal = new bootstrap.Modal(document.getElementById('manageModal'));
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

        function requestConfirmation(msg, callback) { document.getElementById('confirm-msg').innerText = msg; pendingConfirmCallback = callback; confirmModal.show(); }
        function confirmAction(isYes) { confirmModal.hide(); if(isYes && pendingConfirmCallback) pendingConfirmCallback(); pendingConfirmCallback = null; }

        function openLocationsModal() { locMgrModal.show(); fetchLocations(); }
        function scrollToRow(id) { setTimeout(() => { const row = document.getElementById(`row-${id}`); if(row) { row.scrollIntoView({behavior: "smooth", block: "center"}); row.classList.add('highlight-row'); } }, 500); }

        function fetchLocations() {
            fetch('/api/locations').then(r => r.json()).then(data => {
                allLocations = data; 
                document.getElementById('loc-count').innerText = data.length + " Locs";
                document.getElementById('location-table').innerHTML = data.map(l => `
                    <tr id="row-${l.LocationID}">
                        <td style="font-weight:bold;color:#00d4ff;">${l.LocationID}</td>
                        <td>${l.Name}</td>
                        <td>${l.Occupancy || ''} <span class="badge bg-secondary ms-2">${l.Type}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="openEdit('${l.LocationID}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteLoc('${l.LocationID}')">üóëÔ∏è</button>
                            <button class="btn btn-sm btn-info" onclick="openManage('${l.LocationID}')">Manage</button>
                        </td>
                    </tr>`).join('');
                if(lastScannedLoc) scrollToRow(lastScannedLoc);
            });
        }

        function closeManage() { manageModal.hide(); fetchLocations(); }

        function refreshManageList(locId) {
            document.getElementById('manage-contents-list').innerHTML = "<div class='text-center'>Loading...</div>";
            fetch(`/api/get_contents?id=${locId}`).then(r => r.json()).then(data => {
                const list = document.getElementById('manage-contents-list');
                if (data.length === 0) list.innerHTML = "<div class='text-center text-muted'>Empty</div>";
                else {
                    list.innerHTML = data.map((s, idx) => `
                        <div class="manage-item mb-3 p-2 bg-dark border border-secondary rounded d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center"><div id="qr-man-${idx}" class="bg-white p-1 me-3 rounded"></div><div><div class="d-flex align-items-center"><div class="buffer-swatch me-2" style="width:20px;height:20px;background-color:#${s.color};"></div><span class="text-white fw-bold" style="font-size: 1.3rem;">${s.display}</span></div></div></div>
                            <button class="btn btn-danger eject-btn" onclick="ejectSpool(${s.id}, '${locId}')">‚èèÔ∏è EJECT</button>
                        </div>`).join('');
                    data.forEach((s, idx) => { new QRCode(document.getElementById(`qr-man-${idx}`), {text: "ID:" + s.id.toString(), width: 64, height: 64}); });
                }
            });
        }

        function ejectSpool(spoolId, locId) { if(locId !== "Scan") { requestConfirmation("Eject spool #" + spoolId + "?", () => { doEject(spoolId, locId); }); } else doEject(spoolId, locId); }
        function doEject(spoolId, locId) {
            setProcessing(true);
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'remove', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then((res) => { 
                setProcessing(false);
                if (document.getElementById('manage-grid-view').style.display !== 'none') {
                    const locData = allLocations.find(l => l.LocationID === locId);
                    renderSlotGrid(locId, parseInt(locData['Max Spools']));
                } else if(locId !== "Scan") { refreshManageList(locId); }
                fetchLogs(); 
                if(locId === "Scan") showToast("‚èèÔ∏è EJECTED", "warning");
                else showToast("‚èèÔ∏è EJECTED", "warning"); 
            }).catch(() => setProcessing(false));
        }

        function manualAddSpool() {
            const locId = document.getElementById('manage-loc-id').value;
            const spoolId = document.getElementById('manual-spool-id').value;
            if(!spoolId) return;
            setProcessing(true);
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'add', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then(res => {
                setProcessing(false);
                if(res.status === 'error') showToast(res.msg, "error");
                else {
                    document.getElementById('manual-spool-id').value = ""; 
                    if(document.getElementById('manage-grid-view').style.display !== 'none') {
                         const locData = allLocations.find(l => l.LocationID === locId);
                         renderSlotGrid(locId, parseInt(locData['Max Spools']));
                    } else refreshManageList(locId);
                    fetchLogs();
                }
            }).catch(() => setProcessing(false));
        }

        function openAddModal() { locMgrModal.hide(); document.getElementById('modalTitle').innerText = "Add New Location"; document.getElementById('edit-original-id').value = ""; document.getElementById('edit-id').value = ""; document.getElementById('edit-name').value = ""; document.getElementById('edit-max').value = "1"; locModal.show(); }
        function openEdit(locId) {
            const item = allLocations.find(l => l.LocationID === locId); if(!item) return;
            locMgrModal.hide(); document.getElementById('modalTitle').innerText = "Edit Location"; document.getElementById('edit-original-id').value = locId; document.getElementById('edit-id').value = locId;
            document.getElementById('edit-name').value = item.Name || ""; document.getElementById('edit-type').value = item.Type || "Dryer Box"; document.getElementById('edit-max').value = item['Max Spools'] || "1"; locModal.show();
        }
        function closeEdit() { locModal.hide(); locMgrModal.show(); }
        function saveLocation() { 
            const payload = { old_id: document.getElementById('edit-original-id').value, new_data: { LocationID: document.getElementById('edit-id').value, Name: document.getElementById('edit-name').value, Type: document.getElementById('edit-type').value, "Max Spools": document.getElementById('edit-max').value, "Label Printed": "No" }};
            fetch('/api/locations', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }).then(() => { lastScannedLoc = payload.new_data.LocationID; locModal.hide(); locMgrModal.show(); setTimeout(fetchLocations, 200); });
        }
        function deleteLoc(id) { requestConfirmation("Delete Location " + id + " AND unassign all spools?", () => { fetch('/api/locations?id=' + id, { method: 'DELETE' }).then(() => { lastScannedLoc = null; fetchLocations(); }); }); }
        function triggerUndo() { fetch('/api/undo', { method: 'POST' }).then(() => fetchLogs()); }
        function fetchLogs() {
            if(logsPaused) return; 
            fetch('/api/logs').then(r => r.json()).then(data => {
                document.getElementById('live-logs').innerHTML = data.logs.map(l => `<div class="log-${l.type}">[${l.time}] ${l.msg}</div>`).join('');
                document.getElementById('undo-btn').disabled = !data.undo_available;
                document.getElementById('st-spoolman').className = `status-dot ${data.status.spoolman ? 'status-on' : 'status-off'}`;
                document.getElementById('st-filabridge').className = `status-dot ${data.status.filabridge ? 'status-on' : 'status-off'}`;
            });
        }
        setInterval(fetchLogs, 2500);
    </script>
</body>
</html>