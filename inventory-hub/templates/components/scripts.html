<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="{{ url_for('static', filename='js/NoSleep.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/inv_core.js') }}"></script>
<script src="{{ url_for('static', filename='js/modules/inv_wizard.js') }}?v=4"></script>

<script src="{{ url_for('static', filename='js/modules/inv_details.js') }}"></script>

<script src="{{ url_for('static', filename='js/modules/inv_queue.js') }}"></script>

<script src="{{ url_for('static', filename='js/modules/inv_backlog.js') }}"></script>

<script src="{{ url_for('static', filename='js/modules/inv_loc_mgr.js') }}"></script>

<script src="{{ url_for('static', filename='js/modules/inv_search.js') }}"></script>

<script src="{{ url_for('static', filename='js/modules/inv_cmd.js') }}"></script>

<script>
    // Module Initialization
    document.addEventListener('DOMContentLoaded', () => {
        // Bootstrapping
        requestWakeLock();

        // Initialize Modals
        ['locMgrModal', 'locModal', 'manageModal', 'confirmModal',
            'actionModal', 'safetyModal', 'queueModal', 'spoolModal',
            'filamentModal', 'backlogModal'].forEach(id => {
                const el = document.getElementById(id);
                if (el) modals[id] = new bootstrap.Modal(el);
            });

        // Focus Guard Logic
        if (!document.getElementById('focus-guard')) {
            const fg = document.createElement('div');
            fg.id = 'focus-guard';
            fg.innerHTML = `<div class="focus-msg"><div><div style="font-size:5rem;">ðŸš«</div><div style="font-size:3rem;color:#f44;font-weight:bold;">SCANNER PAUSED</div><div class="text-white">Click anywhere to resume</div></div></div>`;
            document.body.appendChild(fg);

            // Allow focus-guard to organically absorb clicks without triggering anything underneath
            fg.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.body.focus();
            };
        }

        // --- EVENT LISTENERS ---
        // ROOT CAUSE FIX: Removed the 'shown.bs.modal' listener for manageModal.
        // inv_loc_mgr.js -> openManage() now handles the full render cycle before showing.

        // Modal Open Interceptor (Auto-disables Deck Modes)
        document.addEventListener('show.bs.modal', () => {
            if (typeof window.resetCommandModes === 'function') {
                window.resetCommandModes();
            }
        });

        // Deck QRs
        generateSafeQR('qr-undo', 'CMD:UNDO', 85);
        generateSafeQR('qr-clear', 'CMD:CLEAR', 85);
        generateSafeQR('qr-drop', 'CMD:DROP', 85);
        generateSafeQR('qr-eject', 'CMD:EJECT', 85);
        generateSafeQR('qr-audit', 'CMD:AUDIT', 85);
        generateSafeQR('qr-locs', 'CMD:LOCATIONS', 85);

        // Modal QRs
        const modalQRs = {
            'qr-safety-yes': 'CMD:CONFIRM', 'qr-safety-no': 'CMD:CANCEL',
            'qr-confirm-yes': 'CMD:CONFIRM', 'qr-confirm-no': 'CMD:CANCEL'
        };
        for (const [id, txt] of Object.entries(modalQRs)) generateSafeQR(id, txt, 120);

        // Location Table Events
        const locTable = document.getElementById('location-table');
        if (locTable) {
            locTable.addEventListener('click', (e) => {
                const btn = e.target.closest('.btn-manage');
                if (btn) window.openManage(btn.dataset.id);
                else if (e.target.closest('.btn-edit')) window.openEdit(e.target.closest('.btn-edit').dataset.id);
                else if (e.target.closest('.btn-delete')) window.deleteLoc(e.target.closest('.btn-delete').dataset.id);
            });
        }

        // Detail Button Events
        const btnPrintAction = document.getElementById('btn-print-action');
        if (btnPrintAction) {
            btnPrintAction.onclick = () => {
                const idText = document.getElementById('detail-id').innerText;
                if (idText) {
                    addToQueue({ id: parseInt(idText), type: 'spool', display: document.getElementById('detail-color-name').innerText });
                    modals.spoolModal.hide();
                }
            };
        }
        const btnFilPrint = document.getElementById('btn-fil-print-action');
        if (btnFilPrint) {
            btnFilPrint.onclick = () => {
                const idText = document.getElementById('fil-detail-id').innerText;
                if (idText) {
                    addToQueue({ id: parseInt(idText), type: 'filament', display: document.getElementById('fil-detail-color-name').innerText });
                    modals.filamentModal.hide();
                }
            };
        }

        // Input Handling
        const manualInput = document.getElementById("manual-spool-id");
        if (manualInput) {
            manualInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") { e.preventDefault(); window.manualAddSpool(); }
            });
        }

        window.addEventListener('blur', () => {
            const g = document.getElementById('focus-guard');
            if (g) {
                g.style.opacity = '1';
                g.style.display = 'flex';
            }
        });

        window.addEventListener('focus', () => {
            const g = document.getElementById('focus-guard');
            if (g) {
                // Focus triggers before MouseDown.
                // We instantly turn the guard transparent so the user feels immediate responsiveness...
                g.style.opacity = '0';
                // ...But we physically keep the DOM element shielding the UI for 100ms 
                // so the browser's hit-tester clicks the invisible guard instead of the buttons underneath it.
                setTimeout(() => {
                    g.style.display = 'none';
                    g.style.opacity = '1'; // reset for next time
                }, 100);
            }
        });

        state.scanStartTime = 0;
        document.addEventListener('keydown', (e) => {
            const g = document.getElementById('focus-guard');
            if ((g && g.style.display === 'flex') || state.processing || e.target.tagName === 'INPUT') return;

            if (e.key === 'Enter') {
                e.preventDefault();
                if (state.scanBuffer.length > 0) {
                    const elapsed = Date.now() - state.scanStartTime;
                    // Normal human typing takes much longer. Scanners fire instantly < 120ms
                    const source = elapsed < 120 ? 'barcode' : 'keyboard';
                    processScan(state.scanBuffer, source);
                }
                state.scanBuffer = "";
                state.scanStartTime = 0;
            }
            else if (e.key.length === 1) {
                if (state.scanBuffer.length === 0) {
                    state.scanStartTime = Date.now();
                }
                state.scanBuffer += e.key;
                clearTimeout(state.bufferTimeout);
                state.bufferTimeout = setTimeout(() => {
                    state.scanBuffer = "";
                    state.scanStartTime = 0;
                }, 2000);
            }
        });

        // Start Core Services
        updateLogState();
        fetchLocations();
        updateQueueUI();

        // Polling
        setInterval(updateLogState, 2500);
    });
</script>