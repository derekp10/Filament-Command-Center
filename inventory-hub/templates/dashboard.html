<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Command Center {{ version }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #0e0e0e; color: #f0f0f0; font-family: 'Segoe UI', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* NAVBAR */
        .navbar { background-color: #1a1a1a; border-bottom: 2px solid #00d4ff; flex-shrink: 0; }
        .navbar-brand { color: #00d4ff !important; font-weight: bold; font-size: 1.5rem; }
        .version-tag { color: #888; font-size: 1rem; margin-left: 10px; font-weight: bold; }
        
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-on { background-color: #00ff00; box-shadow: 0 0 5px #00ff00; }
        .status-off { background-color: #ff4444; box-shadow: 0 0 5px #ff4444; }
        .status-group { margin-right: 20px; font-size: 0.9rem; color: #ccc; display: flex; align-items: center; }

        /* MAIN GRID */
        .main-container { flex-grow: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
        
        /* LEFT: LOGS */
        .col-logs { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        .log-box { flex-grow: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 1.1rem; line-height: 1.6; }
        .log-INFO { color: #00ff00; } .log-WARNING { color: #ffcc00; } .log-ERROR { color: #ff4444; }
        
        /* RIGHT: BUFFER */
        .col-buffer { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
        .buffer-header { padding: 10px; background: #222; border-bottom: 1px solid #333; font-weight: bold; color: #00d4ff; display: flex; justify-content: space-between; }
        .buffer-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
        
        .buffer-item { 
            background: #2a2a2a; border: 1px solid #444; border-radius: 8px; 
            margin-bottom: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .buffer-info { display: flex; align-items: center; gap: 15px; }
        .buffer-swatch { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #fff; }
        .buffer-text { font-size: 1.4rem; color: white; font-weight: bold; }
        .qr-box { background: white; padding: 5px; border-radius: 4px; }

        /* COMMAND DECK (Bottom Right) */
        .cmd-deck { padding: 10px; border-top: 1px solid #333; background: #222; display: flex; justify-content: space-around; }
        .cmd-item { text-align: center; color: white; font-weight: bold; font-size: 0.9rem; }

        /* MODALS */
        .modal-content { background-color: #1e1e1e; color: #f0f0f0; border: 1px solid #444; }
        .form-control, .form-select { background-color: #2a2a2a; color: #fff; border: 1px solid #444; font-size: 1.1rem; }
        .form-control:focus { background-color: #333; color: #fff; border-color: #00d4ff; box-shadow: 0 0 0 0.25rem rgba(0, 212, 255, 0.25); }
        .table { color: #d0d0d0; font-size: 1rem; }
        
        /* SCROLL HIGHLIGHT */
        .highlight-row { animation: highlight 2s ease-out; background-color: #333; }
        @keyframes highlight { 0% { background-color: #00d4ff; color: black; } 100% { background-color: transparent; color: inherit; } }

        /* TOASTS & FOCUS */
        #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 11000; text-align: center; }
        .toast-msg { background: rgba(0,0,0,0.95); color: #fff; padding: 30px; margin-bottom: 20px; border: 4px solid #00d4ff; border-radius: 12px; font-size: 2rem; font-weight: bold; }
        #focus-guard { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: none; justify-content: center; align-items: center; border: 20px solid #ff4444; text-align: center; backdrop-filter: blur(5px); }
        .guard-msg { font-size: 3rem; color: #ff4444; font-weight: bold; text-transform: uppercase; }
        
        /* MANAGE LIST */
        .manage-item { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 15px; margin-bottom: 10px; border-radius: 6px; }
        .manage-qr { background: white; padding: 4px; margin-right: 15px; }
    </style>
</head>
<body>
    <div id="focus-guard" onclick="document.body.focus()">
        <div><div style="font-size:5rem;">üö´</div><div class="guard-msg">Scanner Paused</div><div style="color:white;font-size:1.5rem;">Tap to Resume</div></div>
    </div>

    <div id="toast-container"></div>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <span class="navbar-brand">Filament Command Center</span>
                <span class="version-tag">{{ version }}</span>
            </div>
            <div class="d-flex align-items-center">
                <div class="status-group"><span id="st-spoolman" class="status-dot status-off"></span> Spoolman</div>
                <div class="status-group"><span id="st-filabridge" class="status-dot status-off"></span> FilaBridge</div>
                <button class="btn btn-outline-info btn-sm me-3" onclick="openLocationsModal()">üìÇ Locations</button>
                <button onclick="triggerUndo()" class="btn btn-warning btn-sm me-3" id="undo-btn" disabled>‚Ü©Ô∏è UNDO</button>
                <a href="/api/export_locations" class="btn btn-secondary btn-sm">üíæ Export</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="col-logs">
            <div class="p-2 border-bottom border-secondary text-info fw-bold">Live Activity üì°</div>
            <div id="live-logs" class="log-box"></div>
        </div>

        <div class="col-buffer">
            <div class="buffer-header">
                <span>BUFFER ZONE</span>
                <span id="scan-status" style="font-size:0.9rem; color:#888;">Ready to Scan...</span>
            </div>
            <div id="buffer-zone" class="buffer-content">
                <div class="text-center text-muted mt-5">
                    <h3>Buffer Empty</h3>
                    <p>Scan a Spool or Location</p>
                </div>
            </div>
            <div class="cmd-deck">
                <div class="cmd-item"><div class="qr-box" id="qr-clear"></div>CLEAR</div>
                <div class="cmd-item"><div class="qr-box" id="qr-undo"></div>UNDO</div>
                <div class="cmd-item"><div class="qr-box" id="qr-eject"></div>EJECT</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locMgrModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Location Manager</h5>
                    <div class="ms-3 text-muted" id="loc-count">0 Locations</div>
                    <button class="btn btn-success btn-sm ms-auto me-3" onclick="openAddModal()">+ New Slot</button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <table class="table table-hover table-dark mb-0">
                        <thead><tr><th>ID</th><th>Name</th><th>Type</th><th class="text-end">Actions</th></tr></thead>
                        <tbody id="location-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="locModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="modalTitle">Edit Location</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-original-id">
                    <div class="mb-3"><label>Location ID</label><input type="text" class="form-control" id="edit-id"></div>
                    <div class="mb-3"><label>Friendly Name</label><input type="text" class="form-control" id="edit-name"></div>
                    <div class="mb-3"><label>Type</label>
                        <select class="form-select" id="edit-type">
                            <option value="Dryer Box">Dryer Box</option><option value="Cart">Cart</option><option value="Shelf">Shelf</option>
                            <option value="Printer">Printer/Toolhead</option><option value="MMU Slot">MMU Slot</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" onclick="saveLocation()">Save</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="manageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageTitle">Manage Contents</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="manage-contents-list" class="mb-3"></div>
                    <hr>
                    <label>Add Spool Manually:</label>
                    <div class="input-group">
                        <input type="text" id="manual-spool-id" class="form-control" placeholder="Enter Spool ID">
                        <button class="btn btn-primary" onclick="manualAddSpool()">‚ûï Add</button>
                    </div>
                    <input type="hidden" id="manage-loc-id">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        window.onload = function() {
            new QRCode(document.getElementById("qr-undo"), {text: "CMD:UNDO", width: 80, height: 80});
            new QRCode(document.getElementById("qr-clear"), {text: "CMD:CLEAR", width: 80, height: 80});
            new QRCode(document.getElementById("qr-eject"), {text: "CMD:EJECT", width: 80, height: 80});
        };
        window.onblur = function() { document.getElementById('focus-guard').style.display = 'flex'; };
        window.onfocus = function() { document.getElementById('focus-guard').style.display = 'none'; };

        let scanBuffer = "";
        let bufferTimeout;
        let heldSpools = []; 
        let ejectMode = false;
        let lastScannedLoc = null;

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('focus-guard').style.display === 'flex') return;
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            if (e.ctrlKey || e.altKey || e.metaKey) return;
            
            if (e.key === 'Enter') { processScan(scanBuffer); scanBuffer = ""; } 
            else if (e.key.length === 1) { 
                scanBuffer += e.key; 
                document.getElementById('scan-status').innerText = "Scanning: " + scanBuffer; 
                clearTimeout(bufferTimeout); 
                bufferTimeout = setTimeout(() => { scanBuffer = ""; document.getElementById('scan-status').innerText = "Ready"; }, 2000); 
            }
        });

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `toast-msg`;
            el.style.borderColor = type === 'error' ? '#ff4444' : (type === 'warning' ? '#ffcc00' : '#00d4ff');
            el.style.color = type === 'error' ? '#ff4444' : (type === 'warning' ? '#ffcc00' : '#ffffff');
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 2000);
        }

        function renderBuffer() {
            const zone = document.getElementById('buffer-zone');
            if (heldSpools.length > 0) {
                zone.innerHTML = heldSpools.map((s, idx) => `
                    <div class="buffer-item">
                        <div class="buffer-info">
                            <div class="buffer-swatch" style="background-color:#${s.color}"></div>
                            <div class="buffer-text">${s.display}</div>
                        </div>
                        <div id="qr-buf-${idx}" class="qr-box"></div>
                    </div>
                `).join('');
                
                heldSpools.forEach((s, idx) => {
                    new QRCode(document.getElementById(`qr-buf-${idx}`), {text: s.id.toString(), width: 100, height: 100});
                });
            } else {
                zone.innerHTML = `<div class="text-center text-muted mt-5"><h3>Buffer Empty</h3><p>Scan a Spool or Location</p></div>`;
            }
        }

        function processScan(text) {
            fetch('/api/identify_scan', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: text}) }).then(r => r.json()).then(res => {
                
                if (ejectMode) {
                    ejectMode = false;
                    document.getElementById('buffer-zone').style.border = "none";
                    if (res.type === 'spool') {
                        ejectSpool(res.id, "Scan");
                    } else {
                        showToast("Scan a SPOOL to eject it!", "warning");
                    }
                    return;
                }

                if (res.type === 'spool') {
                    if (heldSpools.some(s => s.id === res.id)) {
                        showToast("‚ö†Ô∏è ALREADY IN BUFFER", "warning");
                    } else {
                        heldSpools.push({id: res.id, display: res.display, color: res.color});
                        renderBuffer();
                    }
                } else if (res.type === 'location') {
                    lastScannedLoc = res.id;
                    if (heldSpools.length > 0) {
                        executeMove(res.id); 
                    } else if (res.contents && res.contents.length > 0) {
                        res.contents.forEach(s => {
                            if (!heldSpools.some(h => h.id === s.id)) heldSpools.push(s);
                        });
                        renderBuffer();
                        showToast(`Loaded ${res.contents.length} Items`, "info");
                    } else {
                        showToast("Location is Empty", "warning");
                    }
                } else if (res.type === 'command') {
                    if (res.cmd === 'undo') triggerUndo();
                    if (res.cmd === 'clear') { heldSpools = []; renderBuffer(); showToast("BUFFER CLEARED", "info"); }
                    if (res.cmd === 'eject') { 
                        ejectMode = true; 
                        showToast("‚ö†Ô∏è SCAN ITEM TO EJECT", "warning"); 
                        document.getElementById('buffer-zone').style.border = "4px solid #ff4444";
                    }
                }
            });
        }

        function executeMove(targetLoc) {
            const spoolIds = heldSpools.map(s => s.id);
            fetch('/api/smart_move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({location: targetLoc, spools: spoolIds}) }).then(r => r.json()).then(data => { 
                heldSpools = []; 
                renderBuffer();
                fetchLogs(); 
                if(data.status === 'success') showToast("‚úÖ MOVE COMPLETE", "info");
                else showToast(data.msg || "‚ùå MOVE FAILED", "error");
            });
        }

        function triggerUndo() { fetch('/api/undo', { method: 'POST' }).then(() => fetchLogs()); }

        // --- MANAGERS ---
        const locMgrModal = new bootstrap.Modal(document.getElementById('locMgrModal'));
        const locModal = new bootstrap.Modal(document.getElementById('locModal'));
        const manageModal = new bootstrap.Modal(document.getElementById('manageModal'));

        function openLocationsModal() {
            locMgrModal.show();
            // AUTO SURFACE LOGIC
            if(lastScannedLoc) {
                setTimeout(() => {
                    const row = document.getElementById(`row-${lastScannedLoc}`);
                    if(row) {
                        row.scrollIntoView({behavior: "smooth", block: "center"});
                        row.classList.add('highlight-row');
                        setTimeout(() => row.classList.remove('highlight-row'), 2000);
                    }
                }, 300);
            }
        }

        function fetchLocations() {
            fetch('/api/locations').then(r => r.json()).then(data => {
                document.getElementById('loc-count').innerText = data.length + " Locations";
                document.getElementById('location-table').innerHTML = data.map(l => `
                    <tr id="row-${l.LocationID}">
                        <td><code>${l.LocationID}</code></td>
                        <td>${l.Name}</td>
                        <td><span class="badge bg-secondary">${l.Type}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-info me-1" onclick="openManage('${l.LocationID}')">Manage</button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="openEdit('${l.LocationID}')">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLoc('${l.LocationID}')">Del</button>
                        </td>
                    </tr>`).join('');
            });
        }

        // --- CONTENT MANAGEMENT (UPDATED) ---
        function openManage(locId) {
            locMgrModal.hide(); // Swap modals
            document.getElementById('manageTitle').innerText = `Manage: ${locId}`;
            document.getElementById('manage-loc-id').value = locId;
            document.getElementById('manual-spool-id').value = "";
            refreshManageList(locId);
            manageModal.show();
        }

        function refreshManageList(locId) {
            document.getElementById('manage-contents-list').innerHTML = "<div class='text-center'>Loading...</div>";
            fetch(`/api/get_contents?id=${locId}`).then(r => r.json()).then(data => {
                const list = document.getElementById('manage-contents-list');
                if (data.length === 0) {
                    list.innerHTML = "<div class='text-center text-muted'>Empty</div>";
                } else {
                    list.innerHTML = data.map((s, idx) => `
                        <div class="manage-item">
                            <div style="display:flex;align-items:center;">
                                <div id="qr-man-${idx}" class="manage-qr"></div>
                                <div style="display:flex;flex-direction:column;">
                                    <span style="font-weight:bold;font-size:1.2rem;color:${s.color}">#${s.id}</span>
                                    <span class="text-muted small">${s.display}</span>
                                </div>
                            </div>
                            <button class="btn btn-danger" onclick="ejectSpool(${s.id}, '${locId}')">‚èèÔ∏è Eject</button>
                        </div>
                    `).join('');
                    
                    data.forEach((s, idx) => {
                        new QRCode(document.getElementById(`qr-man-${idx}`), {text: s.id.toString(), width: 64, height: 64});
                    });
                }
            });
        }

        function ejectSpool(spoolId, locId) {
            if(locId !== "Scan" && !confirm("Eject spool #" + spoolId + "?")) return;
            
            // Optimistic UI Update (for Scan)
            if(locId === "Scan") showToast("‚èèÔ∏è EJECTED", "warning");

            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'remove', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then((res) => { 
                if(locId !== "Scan") refreshManageList(locId); 
                fetchLogs(); 
            });
        }

        function manualAddSpool() {
            const locId = document.getElementById('manage-loc-id').value;
            const spoolId = document.getElementById('manual-spool-id').value;
            if(!spoolId) return;
            fetch('/api/manage_contents', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'add', location: locId, spool_id: spoolId}) })
            .then(r => r.json()).then(res => {
                if(res.status === 'error') alert(res.msg);
                refreshManageList(locId); fetchLogs(); 
                document.getElementById('manual-spool-id').value = "";
            });
        }

        // --- HELPERS ---
        function openAddModal() { locMgrModal.hide(); document.getElementById('modalTitle').innerText = "Add New Location"; document.getElementById('edit-original-id').value = ""; locModal.show(); }
        function openEdit(id) { locMgrModal.hide(); const l = allLocations.find(x => x.LocationID === id); if(!l)return; document.getElementById('modalTitle').innerText="Edit Location"; document.getElementById('edit-id').value=l.LocationID; document.getElementById('edit-name').value=l.Name; document.getElementById('edit-type').value=l.Type; document.getElementById('edit-original-id').value=l.LocationID; locModal.show(); }
        function saveLocation() { 
            const payload = { old_id: document.getElementById('edit-original-id').value, new_data: { LocationID: document.getElementById('edit-id').value, Name: document.getElementById('edit-name').value, Type: document.getElementById('edit-type').value, Location: "", "Device Identifier": "", "Device Type": "", Order: "", Row: "", "Max Spools": "1", "Label Printed": "No" } };
            fetch('/api/locations', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) }).then(() => { locModal.hide(); fetchLocations(); locMgrModal.show(); });
        }
        function deleteLoc(id) { if(confirm("Delete " + id + "?")) fetch('/api/locations?id=' + id, { method: 'DELETE' }).then(() => fetchLocations()); }

        function fetchLogs() {
            fetch('/api/logs').then(r => r.json()).then(data => {
                document.getElementById('live-logs').innerHTML = data.logs.map(l => `<div class="log-${l.type}">[${l.time}] ${l.msg}</div>`).join('');
                document.getElementById('undo-btn').disabled = !data.undo_available;
                
                // Navbar Status Dots
                document.getElementById('st-spoolman').className = `status-dot ${data.status.spoolman ? 'status-on' : 'status-off'}`;
                document.getElementById('st-filabridge').className = `status-dot ${data.status.filabridge ? 'status-on' : 'status-off'}`;
            });
        }

        fetchLocations(); setInterval(fetchLogs, 2500);
    </script>
</body>
</html>