<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filament Command Center {{ version }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- KIOSK THEME (Screen Only) --- */
        @media screen {
            body { background-color: #000; color: #fff; font-family: 'Segoe UI', monospace; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
            .navbar { background-color: #111; border-bottom: 2px solid #00d4ff; flex-shrink: 0; }
            .navbar-brand { color: #00d4ff !important; font-weight: bold; font-size: 1.5rem; }
            .main-container { flex-grow: 1; display: flex; padding: 10px; gap: 10px; overflow: hidden; }
            .col-logs, .col-buffer { flex: 1; display: flex; flex-direction: column; background: #111; border: 1px solid #333; border-radius: 8px; }
            .log-box { flex-grow: 1; overflow-y: auto; padding: 15px; font-family: 'Consolas', monospace; font-size: 1.1rem; color: #eee; white-space: pre-wrap; word-break: break-all; }
            .buffer-item { background: #222; border: 1px solid #555; border-radius: 8px; margin-bottom: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
            .buffer-item.active-item { border: 2px solid #0f0; background: #2a2a2a; }
            .cmd-deck { padding: 15px; background: #1a1a1a; border-top: 1px solid #333; display: flex; justify-content: space-around; }
            .cmd-btn { cursor: pointer; border-radius: 8px; padding: 10px; text-align: center; }
            .qr-box { background: white; padding: 5px; border-radius: 4px; }
            
            /* Hide the Print Label on Screen */
            #printable-label-container { display: none; }
        }

        /* --- PHASE 1: GEOMETRY CHECK (Print Only) --- */
        @media print {
            body * { visibility: hidden; } /* Hide everything */
            
            /* FORCE PAGE GEOMETRY */
            @page { 
                size: 50mm 24mm; 
                margin: 0mm !important; /* Force 0 margins in CSS */
            }
            
            html, body {
                width: 50mm; height: 24mm;
                margin: 0; padding: 0;
                overflow: hidden;
            }

            /* Show Label Container */
            #printable-label-container, #printable-label-container * { visibility: visible; }
            
            #printable-label-container {
                position: fixed; top: 0; left: 0;
                width: 50mm; height: 24mm;
                background: white;
                color: black;
                font-family: Arial, sans-serif;
                /* Simple Flex Layout */
                display: flex;
                align-items: center;
                padding: 1mm; /* Safety Margin */
                box-sizing: border-box;
                border: 1px dashed red; /* Debug Border - Shows printable area */
            }
        }

        /* SIMPLE CONTENT STYLING */
        .phase1-qr {
            width: 20mm;
            height: 20mm;
            border: 1px solid blue; /* Debug Border */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .phase1-qr img { width: 100%; height: auto; }

        .phase1-text {
            flex-grow: 1;
            margin-left: 2mm;
            font-size: 10pt;
            font-weight: bold;
            border: 1px solid green; /* Debug Border */
            height: 20mm;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="printable-label-container">
        <div class="phase1-qr" id="print-qr"></div>
        <div class="phase1-text" id="print-text">WAITING...</div>
    </div>

    <div id="processing-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;"></div>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand">Phase 1 Test</span>
        </div>
    </nav>

    <div class="main-container">
        <div class="col-logs">
            <div class="p-3 text-info fw-bold">Scan Spool to Print</div>
            <div id="live-logs" class="log-box"></div>
        </div>
        <div class="col-buffer">
            <div class="buffer-header">CONTROLS</div>
            <div class="p-3">
                <input type="text" id="manual-spool-id" class="form-control mb-3" placeholder="Enter Spool ID">
                <button class="btn btn-primary w-100" onclick="manualPrint()">üñ®Ô∏è TEST PRINT</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const setProcessing = (s) => document.getElementById('processing-overlay').style.display = s ? 'block' : 'none';

        // --- PHASE 1 PRINT LOGIC ---
        const printLabel = (sid) => {
            setProcessing(true);
            fetch(`/api/spool_details?id=${sid}`).then(r=>r.json()).then(data => {
                setProcessing(false);
                const fil = data.filament || {};
                const vendor = fil.vendor ? fil.vendor.name : "Generic";
                const material = fil.material || "PLA";
                
                // 1. Generate QR
                document.getElementById('print-qr').innerHTML = "";
                new QRCode(document.getElementById('print-qr'), {
                    text: `ID:${sid}`,
                    width: 100, height: 100,
                    correctLevel: QRCode.CorrectLevel.L
                });

                // 2. Set Text
                document.getElementById('print-text').innerHTML = `${vendor}<br>${material}<br>#${sid}`;

                // 3. Print
                setTimeout(() => window.print(), 500);
            }).catch(() => setProcessing(false));
        };

        const manualPrint = () => {
            const val = document.getElementById('manual-spool-id').value;
            if(val) printLabel(val);
        };
    </script>
</body>
</html>